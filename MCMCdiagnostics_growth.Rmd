---
 title: "MCMC diagnostics - Growth"
 subtitle: "Test v7.0 - Random effect on the baseline growth rate (pdg)"
 author: "Will Vieira"
 date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---


## Compare the convergence of the model with and without random effect on the parameter $pdg$:

- sim1: no random effect
- sim2: random $pdg$ at the plot level

```{r, echo = F, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggpubr))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(require(RColorBrewer))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(ranger))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(MuMIn))
```
```{r load simulations, echo = F}
# Load simulation variables
  simInfo <- yaml::read_yaml('_simulation_info.yml')

  # species id
  if(is.null(simInfo$spIds)) {
    spIds <- readRDS('data/spIds.RDS')
  }else {
    spIds <- simInfo$spIds
  }

  simName <- simInfo$simName

  simulations <- simInfo$simulations

  # Human readble simName
  sim1name <- 'Basal area'
  sim2name <- 'Canopy distance'

#


# Load rStan output and scaleInfo for all species_id
  # get output name for each species_id
  simNames = list.files(path = paste('output', simName, sep = '/'), pattern = '.RDS', recursive = TRUE, full.names = TRUE)
  output = simNames[grep('growthMCMC', simNames)]

  for(sim in simulations) {
    for(sp in spIds) {
      fileName <- output[grep(paste0(sim, sp), output)]
      assign(paste('fit', sim, sp, sep = '_'), readRDS(fileName))
    }
  }

  # get name of parameters for each simulation
  for(sim in simulations)
  {
    # get one MCMC file for a specific sim
    assign(paste0('pars_', sim), rownames(summary(get(ls(pattern = sim)[1]))[[1]]))
  }

```



# Rhat

```{r, echo = F, fig.height = 6, fig.width = 10}

  # number of parameters for all simulations
  nbParams <- prod(unlist(lapply(as.list(paste0('pars_', simulations)), function(x) length(get(x)))))
  # create a table with Rhat for each parameter (clumn) and species_id (Rhat)
  Rhat <- data.frame()
  count = 1
  for(sim in simulations) {
    for(sp  in spIds) {
      df <- summary(get(paste('fit', sim, sp, sep = '_')))$summary
      dfToAdd <- data.frame(
          sim, 
          sp,
          rownames(df),
          df[, 'Rhat'],
          row.names = NULL
      )
      Rhat <- rbind(Rhat, dfToAdd)
    }
  }
  names(Rhat) <- c('sim', 'sp', 'pars', 'Rhat')

  p <- ggplot(data = Rhat, aes(x = sp, y = Rhat)) +
       geom_boxplot() +
       coord_flip() +
       facet_grid(~sim, scales = 'free_x',
                 labeller = labeller(sim = setNames(c(sim1name, sim2name),
                                     c('sim1', 'sim2'
                                    )))) +
       theme_classic()
  print(p)
```



# Divergent transitions

```{r divergent transitions, echo = FALSE}

divergentDF <- data.frame(matrix(NA, ncol = 3))
names(divergentDF) <- c('sim', 'sp', 'divergent')

count = 1
for(sim in simulations) {
  for(sp in spIds) {
    simNames <- paste('fit', sim, sp, sep = '_')
    sampler_params <- get_sampler_params(get(simNames), inc_warmup = FALSE)
    nbDivergent <- sum(unlist(lapply(sampler_params, function(mat) mat[, 'divergent__'])))
    divergentDF[count, ] <- c(sim, sp, nbDivergent)
    count = count + 1
  }
}
```

```{r divergent table, echo = FALSE}
DT::datatable(divergentDF)
```



# Density plot of each parameter by species id

```{r get MCMC sampling data, echo = F}
  # Prepare data
  # Data frame with sim, sp_id, pars and value
  # Value is all MCMC samples after warmup for all chains together

  mcmcSampleDF <- data.frame()
  for(sim in simulations)
  {
    for(sp in spIds)
    {
      dfToAdd <- gather(
          as.data.frame(
            get(paste('fit', sim, sp, sep = '_'))
          ),
          key = 'pars'
        )
      
      dfToAdd$sp <- sp
      dfToAdd$sim <- sim

      mcmcSampleDF <- rbind(
        mcmcSampleDF,
        dfToAdd
      )
    }
  }

  # Get the parameters from the random plot_id
  mcmcSampleDF_random <- subset(mcmcSampleDF, pars %in% grep('pdg_pmean', unique(mcmcSampleDF$pars), value = TRUE))
```

```{r plot mcmcSample by pars, echo = F, message=FALSE, fig.height = 7, fig.width = 7}
  # Remove parameters from the random plot_id
  parsToPlot <- setdiff(unique(mcmcSampleDF$pars), grep('pdg_pmean', unique(mcmcSampleDF$pars), value = TRUE))
  for(par in parsToPlot)
  {
    p <- ggplot(data = subset(mcmcSampleDF, pars == par), aes(value, sp, fill = sim, color = sim)) +
         geom_density_ridges(alpha = 0.5) +
         theme_classic() +
         xlab(par)
    print(p)
  }

  ggplot(data = mcmcSampleDF_random, aes(value, sp)) +
        geom_density_ridges(alpha = 0.5) +
        theme_classic() +
        xlab('Random effect of pdg at the population level')

  rm(mcmcSampleDF, mcmcSampleDF_random, dfToAdd)
```

# Data distribution

```{r organize data, echo = FALSE}
growth_dt <- readRDS('data/growth_dt.RDS')
growth_dt <- growth_dt[species_id %in% spIds]
growth <- growth_dt[, .(plot_id, species_id, growth, dbh0, deltaYear, mean_temp_period_3_lag, tot_annual_pp_lag, BA, canopyDistance)]

# transform dt
growth <- tidyr::gather(data = growth,
            growth, dbh0, mean_temp_period_3_lag, tot_annual_pp_lag, BA, canopyDistance,
            key = 'var', value = 'value')
```

```{r plot data distribution, echo = FALSE, message=FALSE, fig.height = 7, fig.width = 10}
p <- ggplot(data = growth, aes(value, species_id)) +
      geom_density_ridges_gradient() +
      facet_grid(~var, scales = 'free_x') + #,
      #          labeller = labeller(sim = setNames(c(sim1name,
      #                              sim2name),
      #                              c('sim1', 'sim2')))) +
      theme_classic()
print(p)

rm(growth)
```


# Size, temperature, precipitation and competition effect

```{r, echo = F, fig.height = 13, fig.width = 9}
# Plot of size, temperature, precipitation and competition effect

  # define functions of the model
    # size effect
    sizeEffect = function(x, Phi_opt, sigmaPhi_opt) {
      lgPart <- (log(x/Phi_opt)/sigmaPhi_opt)^2
      return( exp(-lgPart))
    }

    # temperature effect
    tempEffect = function(xtemp, T_opt, sigmaT_opt) {
      return(0.0001 + exp(-0.5*(xtemp - T_opt)^2/sigmaT_opt^2))
    }

    # precipitation effect
    precEffect = function(xprec, P_opt, sigmaP_opt) {
      return(exp(-0.5*(xprec - P_opt)^2/sigmaP_opt^2))
    }

    compEffect = function(x, params, sim) {
      if(sim == 'sim1') {
        return( exp(-((x^2)/2 * params['sigma_C', 1]^2)) )
      }else{
        return( (params['Lo', 1] + ((1 - params['Lo', 1]) / (1 + exp(-0.45 * (x))))) )
      }
    }

  #

  ## PLOT ##

 # define x axis
  sizex = seq(0, 1100, 0.5)
  tempx = seq(5, 25)
  precx = seq(100, 2000)

  # species specfic colours
  spCols <- rev(RColorBrewer::brewer.pal(length(spIds), "Set3"))
  par(mfrow = c(4, length(simulations)), xaxs = "i", las = 1, mar = c(3, 1, 1.5, 1.5), oma = c(1,3.5,2,.2), mgp = c(1.5, 0.3, 0), tck = -.008, cex.lab = 1.2, cex.axis = 1.2)
  # plot size effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary
      # plot
      if(sp == 1) plot(sizex, sizeEffect(sizex, out['Phi_opt', 1], out['sigmaPhi_opt', 1]),
                  type = 'l', ylim = c(0, 1), xlab = 'Size (mm)', ylab = 'Size effect',
                  col = spCols[sp],
                  yaxt = ifelse(sim == 'sim1', "s", "n"))
      if(sim == 'sim2') axis(2, labels = FALSE)
      points(sizex, sizeEffect(sizex, out['Phi_opt', 1], out['sigmaPhi_opt', 1]), type = 'l', col = spCols[sp])
      abline(v = growth_dt[species_id == spIds[sp], range(dbh0)], col = spCols[sp], lwd = 1, lty = c(2, 4))
    }
    mtext(ifelse(sim == 'sim1', paste0('sim: ', sim1name), paste0('sim: ', sim2name)), side = 3, line = 0)
    if(sim == 'sim1') mtext("Size effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot temp effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary
      topt <- out['T_opt', 1]
      sigTopt <- out['sigmaT_opt', 1]

      if(sp == 1) plot(tempx, tempEffect(tempx, topt, sigTopt), type = 'l',
                  ylim = c(0, 1), xlab = 'Annual mean temperature period 3 (°C)', ylab = 'Temperature effect',
                  col = spCols[sp],
                  yaxt = ifelse(sim == 'sim1', "s", "n"))
      if(sim == 'sim2') axis(2, labels = FALSE)
      points(tempx, tempEffect(tempx, topt, sigTopt), type = 'l', col = spCols[sp])
      abline(v = growth_dt[species_id == spIds[sp], range(mean_temp_period_3_lag)], col = spCols[sp], lwd = 1, lty = c(2, 4))
    }
    if(sim == 'sim1') mtext("Temperature effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot precipitation effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary
      popt <- out['P_opt', 1]
      sigPopt <- out['sigmaP_opt', 1]

      if(sp == 1) plot(precx, precEffect(precx, popt, sigPopt), type = 'l',
                  ylim = c(0, 1), xlab = 'Precipiation (mm)', ylab = 'Precipiation effect',
                  col = spCols[sp],
                  yaxt = ifelse(sim == 'sim1', "s", "n"))
      if(sim == 'sim2') axis(2, labels = FALSE)
      points(precx, precEffect(precx, popt, sigPopt), type = 'l', col = spCols[sp])
      abline(v = growth_dt[species_id == spIds[sp], range(tot_annual_pp_lag)], col = spCols[sp], lwd = 1, lty = c(2, 4))
    }
    if(sim == 'sim1') mtext("Precipiation effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot competition effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary

      if(sim == 'sim1') {
        x = seq(0, 120, 0.1)
      }else{
        x = seq(-35, 45, 0.1)
      }
      if(sp == 1) 
        plot(x, compEffect(x, out, sim),
            ylim = c(0, 1), type = 'l', xlab = ifelse(sim == 'sim1', 'Basal area', 'Canopy distance'), ylab = 'Competition effect',
            col = spCols[sp],
            yaxt = ifelse(sim == 'sim1', "s", "n")
        )
        if(sim == 'sim2') axis(2, labels = FALSE)
        points(x, compEffect(x, out, sim), type = 'l', col = spCols[sp])
      if(sim == 'sim1'){
        abline(v = growth_dt[species_id == spIds[sp], range(BA)], col = spCols[sp], lwd = 1, lty = c(2, 4))
      }else{
        abline(v = growth_dt[species_id == spIds[sp], range(canopyDistance)], col = spCols[sp], lwd = 1, lty = c(2, 4))
      }
    }
    if(sim == 'sim1') mtext("Competition effect", 2, las = 0, cex = .8, line = 1.9)
  }
  legend('bottomright', legend = spIds, col = spCols, lty = 1, bty = 'n', cex = 0.9)
```


# Predictions

```{r, echo = F}
# Plot predictions
  # define model

  growth_model <- function(param, sim, newdata, indVar = FALSE)
  {

    lgPart <- (log(newdata$D/param["Phi_opt"])/param["sigmaPhi_opt"])^2

    if(sim == 'sim1') {
      compEffect <- exp(-((newdata$BA^2)/2*param["sigma_C"]^2))
    }else{
      compEffect <- (param['Lo'] + ((1 - param['Lo']) / (1 + exp(-0.45 * (newdata$BA)))))
    }
    mu_d <- param["pdg"] *
            compEffect *
            exp(-0.5*(newdata$TP - param["T_opt"])^2/param["sigmaT_opt"]^2) *
            exp(-0.5*(newdata$PP - param["P_opt"])^2/param["sigmaP_opt"]^2) *
            exp(-lgPart)

    if(!indVar)
    {
      growth <- mu_d
    }else {
      lower <- qgamma(.95, (mu_d^2/param["sigma_base"]), mu_d/param["sigma_base"], lower.tail = FALSE)
      upper <- qgamma(.95, (mu_d^2/param["sigma_base"]), mu_d/param["sigma_base"])
      growth <- data.frame(means = mu_d, lower = lower, upper = upper)
    }

    return( cbind(growth, newdata) )
  }

  # Function in which you give a rstan output (species_id) and it returns the three plots
  plot_prediction <- function(sim, sp, model, data) {

    # Prepare data
    newdataT <- data[['newdataT']]
    newdataP <- data[['newdataP']]
    newdataD <- data[['newdataD']]
    newdataC <- data[['newdataC']]

    # simulation
    fit <- get(paste('fit', sim, sp, sep = '_'))

    # define ylim
    yLim <- c(0, summary(fit)$summary['pdg', '97.5%'] + summary(fit)$summary['sigma_base', '97.5%'])
  
    # posterior distribution
    posterior <- rstan::extract(fit)

    param_summary <- summary(fit, probs = c(0.1, 0.9))$summary
    #rownames(param_summary) <- names(posterior)
    param_summary <- param_summary[,-c(2:3)]

    # define parameters
    nRow <- nrow(param_summary)
    param_mean <- param_summary[-nRow, 1]
    param_ci10 <- param_summary[-nRow, 2]
    param_ci90 <- param_summary[-nRow, 3]

    ba2plot <- unique(newdataT$BA)
    colba <- rev(RColorBrewer::brewer.pal(length(ba2plot) + 1, "PuBuGn"))
    colba_indVar <- rev(RColorBrewer::brewer.pal(length(ba2plot) + 1, "Greens"))

    if(sim == 'sim1')
      par(mfcol = c(4, length(simulations) * 2), xaxs="i", las = 1, mar = c(3, 1, 3, 1.5), oma = c(1,3.5,2,.2), mgp = c(1.5, 0.3, 0), tck = -.008, cex.lab = 1.2, cex.axis = 1.2)

    # Name of variables needed by the growth_model
    varNames <- names(newdataT)

    for(indVar in c(FALSE, TRUE))
    {
      # Growth vs temperature

      # get predictions
      if(!indVar)
      {
        growth_meanT <- growth_model(param = param_mean, sim = sim, newdata = newdataT)
        growth_ci10T <- growth_model(param = param_ci10, sim = sim, newdata = newdataT)
        growth_ci90T <- growth_model(param = param_ci90, sim = sim, newdata = newdataT)
      }else {
        DF <- growth_model(param = param_mean, sim = sim, newdata = newdataT, indVar = TRUE)
        growth_meanT <- DF[, c('means', varNames)]
        growth_ci10T <- DF[, c('lower', varNames)]
        growth_ci90T <- DF[, c('upper', varNames)]
        names(growth_meanT)[1] <- names(growth_ci10T)[1] <- names(growth_ci90T)[1] <- 'growth'
      }

      plot(growth ~ TP, growth_ci90T, type = "n", ylim = yLim,
          xlab = "Temperature (°C)", ylab = "", cex.lab = 1.2, yaxt = ifelse(sim == 'sim1', "s", "n"))
      if(sim == 'sim2') axis(2,labels=F)
      for(ba in ba2plot) {
        mu <- subset(growth_meanT, BA == ba)
        ci10 <- subset(growth_ci10T, BA == ba)
        ci90 <- subset(growth_ci90T, BA == ba)
        mycol <- ifelse(indVar, colba_indVar[ba2plot == ba], colba[ba2plot == ba])

        lines(growth ~ TP, mu, cex=.5, pch=19, col = mycol)
        polygon(c(mu$TP, rev(mu$TP)),
                c(ci10$growth, rev(ci90$growth)),
                col = alpha(mycol, ifelse(indVar, 0.15, 0.5)), border = NA)
      }
      # add data range
      abline(v = growth_dt[species_id == sp, range(mean_temp_period_3_lag)], col = 'grey', lty = 2)

      if(indVar)
      {
        legend("topleft", legend = ba2plot, title = ifelse(sim == 'sim1', "Canopy distance", "Basal area"),
                fill = colba_indVar[1:3], bty = "n", border = "transparent")
      }else{
        legend("topleft", legend = ba2plot, title = ifelse(sim == 'sim1', "Canopy distance", "Basal area"),
                fill = colba[1:3], bty = "n", border = "transparent")
      }

      mtext(ifelse(indVar, 'ind variation', 'par variation'), side = 3, line = 0.3, cex = 1)
      if(!indVar) mtext(ifelse(sim == 'sim1', sim1name, ifelse(sim == 'sim2', sim2name, sim3name)), side = 3, line = 0.7, at = max(newdataT$TP), cex = 1.1)
      if(!indVar) mtext(sp, side = 3, outer = TRUE, cex = 1, line = -1.8)

      # Growth vs precipitation

      # get predictions
      if(!indVar)
      {
        growth_meanP <- growth_model(param = param_mean, sim = sim, newdata = newdataP)
        growth_ci10P <- growth_model(param = param_ci10, sim = sim, newdata = newdataP)
        growth_ci90P <- growth_model(param = param_ci90, sim = sim, newdata = newdataP)
      }else {
        DF <- growth_model(param = param_mean, sim = sim, newdata = newdataP, indVar = TRUE)
        growth_meanP <- DF[, c('means', varNames)]
        growth_ci10P <- DF[, c('lower', varNames)]
        growth_ci90P <- DF[, c('upper', varNames)]
        names(growth_meanP)[1] <- names(growth_ci10P)[1] <- names(growth_ci90P)[1] <- 'growth'
      }

      plot(growth ~ PP, growth_ci90P, type = "n", ylim = yLim,
          xlab = "Precipiation (mm)", ylab = " ", yaxt = ifelse(sim == 'sim1', "s", "n"), cex.lab = 1.2)
      axis(2, labels = F)
      for(ba in ba2plot) {
        mu <- subset(growth_meanP, BA == ba)
        ci10 <- subset(growth_ci10P, BA == ba)
        ci90 <- subset(growth_ci90P, BA == ba)
        mycol <- ifelse(indVar, colba_indVar[ba2plot == ba], colba[ba2plot == ba])

        lines(growth ~ PP, mu, cex = .5, pch = 19, col = mycol)
        polygon(c(mu$PP, rev(mu$PP)),
                c(ci10$growth, rev(ci90$growth)),
                col = alpha(mycol, ifelse(indVar, 0.15, 0.5)), border = NA)
      }
      # add data range
      abline(v = growth_dt[species_id == sp, range(tot_annual_pp_lag)], col = 'grey', lty = 2)

      mtext("Growth rate (mm/year)", 2, outer = T, las = 0, cex = .8, line = 1.5)

      # Growth vs size

      # get predictions
      if(!indVar)
      {
        growth_meanD <- growth_model(param = param_mean, sim = sim, newdata = newdataD)
        growth_ci10D <- growth_model(param = param_ci10, sim = sim, newdata = newdataD)
        growth_ci90D <- growth_model(param = param_ci90, sim = sim, newdata = newdataD)
      }else {
        DF <- growth_model(param = param_mean, sim = sim, newdata = newdataD, indVar = TRUE)
        growth_meanD <- DF[, c('means', varNames)]
        growth_ci10D <- DF[, c('lower', varNames)]
        growth_ci90D <- DF[, c('upper', varNames)]
        names(growth_meanD)[1] <- names(growth_ci10D)[1] <- names(growth_ci90D)[1] <- 'growth'
      }

      plot(growth ~ D, growth_ci10D, type = "n", ylim = yLim,
          xlab = "Size (mm)", ylab = "", yaxt = ifelse(sim == 'sim1', "s", "n"), cex.lab = 1.2)
      axis(2, labels = F)
      for(ba in ba2plot) {
        mu <- subset(growth_meanD, BA == ba)
        ci10 <- subset(growth_ci10D, BA == ba)
        ci90 <- subset(growth_ci90D, BA == ba)
        mycol <- ifelse(indVar, colba_indVar[ba2plot == ba], colba[ba2plot == ba])

        lines(growth ~ D, mu, cex = .5, pch = 19, col = mycol)
        polygon(c(mu$D, rev(mu$D)),
                c(ci10$growth, rev(ci90$growth)),
                col = alpha(mycol, ifelse(indVar, 0.15, 0.5)), border = NA)
      }
      # add data range
      abline(v = growth_dt[species_id == sp, range(dbh0)], col = 'grey', lty = 2)

      # Growth vs competition

      # get predictions
      if(!indVar)
      {
        growth_meanC <- growth_model(param = param_mean, sim = sim, newdata = newdataC)
        growth_ci10C <- growth_model(param = param_ci10, sim = sim, newdata = newdataC)
        growth_ci90C <- growth_model(param = param_ci90, sim = sim, newdata = newdataC)
      }else {
        DF <- growth_model(param = param_mean, sim = sim, newdata = newdataC, indVar = TRUE)
        growth_meanC <- DF[, c('means', varNames)]
        growth_ci10C <- DF[, c('lower', varNames)]
        growth_ci90C <- DF[, c('upper', varNames)]
        names(growth_meanC)[1] <- names(growth_ci10C)[1] <- names(growth_ci90C)[1] <- 'growth'
      }

      plot(growth ~ BA, growth_ci10C, type = "n", ylim = yLim,
          xlab = ifelse(sim == 'sim1', "Basal area (m²/ha)", "Canopy distance (m)"), ylab = "", yaxt = ifelse(sim == 'sim1', "s", "n"), cex.lab = 1.2)
      axis(2, labels = F)
      lines(growth ~ BA, growth_meanC, cex = .5, pch = 19, col = mycol)
      polygon(c(growth_meanC$BA, rev(growth_meanC$BA)),
              c(growth_ci10C$growth, rev(growth_ci90C$growth)),
              col = alpha("grey25", 0.1), border = NA)

      # add data range
      abline(v = growth_dt[species_id == sp, range(get(ifelse(sim == 'sim1', 'BA', 'canopyDistance')))], col = 'grey', lty = 2)

    }
  }
  ```

  ```{r plot predictions,echo=FALSE,fig.height = 14, fig.width = 12}
  # plot all species
  for(sp in spIds) {
    for(sim in simulations) {
      # fixed data for prediction depending on competition variable
      if(sim == 'sim1')
      {
        # Temp
        newdataT <- data.frame(expand.grid(BA = c(5, 20, 40),
                                          CD = 0,
                                          TP = seq(5, 25, length.out = 300),
                                          PP = 1000,
                                          D = 200))
        # Prec
        newdataP <- data.frame(expand.grid(BA = c(5, 20, 40),
                                          CD = 0,
                                          TP = 15,
                                          PP = seq(250, 1800, length.out = 300),
                                          D = 200))
        # Size
        newdataD <- data.frame(expand.grid(BA = c(5, 20, 40),
                                          CD = 0,
                                          TP = 15,
                                          PP = 1000,
                                          D = seq(0, 900, length.out = 300)))

        # Basal area
        newdataC <- data.frame(expand.grid(BA = seq(0, 100, length.out = 300),
                                          CD = 0,
                                          TP = 15,
                                          PP = 1000,
                                          D = 200))
      }else {
                # Temp
        newdataT <- data.frame(expand.grid(BA = c(-5, 0, 10),
                                          CD = 0,
                                          TP = seq(5, 25, length.out = 300),
                                          PP = 1000,
                                          D = 200))
        # Prec
        newdataP <- data.frame(expand.grid(BA = c(-5, 0, 10),
                                          CD = 0,
                                          TP = 15,
                                          PP = seq(250, 1800, length.out = 300),
                                          D = 200))
        # Size
        newdataD <- data.frame(expand.grid(BA = c(-5, 0, 10),
                                          CD = 0,
                                          TP = 15,
                                          PP = 1000,
                                          D = seq(0, 900, length.out = 300)))

        # Basal area
        newdataC <- data.frame(expand.grid(BA = seq(-30, 45, length.out = 300),
                                          CD = 0,
                                          TP = 15,
                                          PP = 1000,
                                          D = 200))
      }

      
      plot_prediction(
        sim, sp, growth_model,
        data = list(newdataT = newdataT, newdataP = newdataP, newdataD = newdataD, newdataC = newdataC)
      )
    }
  }

```

# Out-of-bag predictions

To compare the model efficiency, we plot the 1:1, and the regression line from `lm(pred_growth ~ observed_growth)` for both Bayesian and random forest methods as reference.

```{r organize data by sp for OOB predictions,echo=FALSE,fig.height = 12, fig.width = 12}
  # create a list of data.table objects for each spIds
  # For each data.table, we will get all rows that were not used in the fitting stan model
  # I have to do it as the sampleIndices where saved when the data frame was already filtered for the specific sp

  oob_list <- list()
  for(sp in spIds)
  {
    # sp specific db
    db <- growth_dt[species_id == sp]

    # load plot_id references and update plot_id to ID_PE
    toSub <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/toSub_sim1.RDS'))
    db[toSub, on = .(plot_id), plot_id_seq := i.plot_id_seq]

    # load rows used for stan fit
    sampledIndices <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/sampledIndices_sim1.RDS'))

    db <- db[!sampledIndices, ]
    db <- db[!is.na(plot_id_seq), ]

    oob_list[[sp]] <- db[!is.na(plot_id), ]
  }
```

```{r calculate OOB predictions,echo=FALSE,fig.height = 12, fig.width = 12}

  # growth model
  growth_model2 <- function(param, sim, D, TP, PP, C, BA, plot_id, indVar = FALSE)
  {
    lgPart <- (log(D/param["Phi_opt"])/param["sigmaPhi_opt"])^2

    # competition
    if(sim == 'sim1')
    {
      compEffect <- exp(-((BA^2)/2*param["sigma_C"]^2))
    }else{
      compEffect <- (param['Lo'] + ((1 - param['Lo']) / (1 + exp(-0.45 * (C)))))
    }

    if(indVar)
    {
      pdg_pop <- param["pdg"] + rnorm(length(D), param[paste0('pdg_pmean[', plot_id, ']')], param["pdg_psd"])
      pdg_pop[pdg_pop <= 0] = 0.0001
    }else
    {
      pdg_pop <- param["pdg"] + param[paste0('pdg_pmean[', plot_id, ']')]
    } 

    mu_d <- pdg_pop *
            compEffect *
            exp(-0.5*(TP - param["T_opt"])^2/param["sigmaT_opt"]^2) *
            exp(-0.5*(PP - param["P_opt"])^2/param["sigmaP_opt"]^2) *
            exp(-lgPart)

    if(!indVar)
    {
      growth <- mu_d
    }else {
      growth <- rgamma(length(D), (mu_d^2/param["sigma_base"]), mu_d/param["sigma_base"])
    }

    return( growth )
  }

  # loop over species and simulations
  r2Sp_ls <- list()
  sampleN <- 30

  for(sp in spIds)
  {
    for(sim in simulations)
    {
      # get params
      fit <- get(paste('fit', sim, sp, sep = '_'))
      posterior <- rstan::extract(fit)

      param_summary <- summary(fit, probs = c(0.1, 0.9))$summary
      param_summary <- param_summary[, -c(2:3)]

      nRow <- nrow(param_summary)
      param_mean <- param_summary[-nRow, 1]
      param_ci10 <- param_summary[-nRow, 2]
      param_ci90 <- param_summary[-nRow, 3]

      if(sim == 'sim1')
      {
        # get deterministic growth rate
        oob_list[[sp]][, Gdet_mean_sim1 := growth_model2(param = param_mean, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]
        oob_list[[sp]][, Gdet_ci10_sim1 := growth_model2(param = param_ci10, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]
        oob_list[[sp]][, Gdet_ci90_sim1 := growth_model2(param = param_ci90, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]

        # get growth rate with individual parameter AND individual variation
        summ_mat <- matrix(rep(0, nrow(oob_list[[sp]]) * sampleN), ncol = sampleN)
        r2_sim1 <- numeric(sampleN)
        # First sample for the random effect parameters and rename them
        pdg_pars <- lapply(lapply(seq_len(ncol(posterior[['pdg_pmean']])), function(i) posterior[['pdg_pmean']][,i]), sample, sampleN)
        names(pdg_pars) <- paste0('pdg_pmean[', 1:length(pdg_pars), ']')
        
        # sample the remaining parameters and merge with pdg_ random effect
        params <- lapply(posterior[-which(names(posterior) == 'pdg_pmean')], sample, sampleN)
        params <- append(params, pdg_pars)        
        for(i in 1:sampleN)
        {
          summ_mat[, i] <- oob_list[[sp]][, growth_model2(unlist(lapply(params, `[[`, i)), sim = sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = TRUE)]
          r2_sim1[i] <- summary(lm(summ_mat[, i] ~ oob_list[[sp]]$growth))$r.squared
        }
        oob_list[[sp]][, Gvar_mean_sim1 := apply(summ_mat, 1, mean, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci10_sim1 := apply(summ_mat, 1, quantile, probs = 0.1, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci90_sim1 := apply(summ_mat, 1, quantile, probs = 0.9, na.rm = TRUE)]
  
      }else{
          # get deterministic growth rate
        oob_list[[sp]][, Gdet_mean_sim2 := growth_model2(param = param_mean, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]
        oob_list[[sp]][, Gdet_ci10_sim2 := growth_model2(param = param_ci10, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]
        oob_list[[sp]][, Gdet_ci90_sim2 := growth_model2(param = param_ci90, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]

        # get growth rate with individual parameter AND individual variation
        summ_mat <- matrix(rep(0, nrow(oob_list[[sp]]) * sampleN), ncol = sampleN)
        r2_sim2 <- numeric(sampleN)
        # First sample for the random effect parameters and rename them
        pdg_pars <- lapply(lapply(seq_len(ncol(posterior[['pdg_pmean']])), function(i) posterior[['pdg_pmean']][,i]), sample, sampleN)
        names(pdg_pars) <- paste0('pdg_pmean[', 1:length(pdg_pars), ']')
        # sample the remaining parameters and merge with pdg_ random effect
        params <- lapply(posterior[-which(names(posterior) == 'pdg_pmean')], sample, sampleN)
        params <- append(params, pdg_pars)

        for(i in 1:sampleN)
        {
          summ_mat[, i] <- oob_list[[sp]][, growth_model2(unlist(lapply(params, `[[`, i)), sim = sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = TRUE)]
          r2_sim2[i] <- summary(lm(summ_mat[, i] ~ oob_list[[sp]]$growth))$r.squared
        }
        oob_list[[sp]][, Gvar_mean_sim2 := apply(summ_mat, 1, mean, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci10_sim2 := apply(summ_mat, 1, quantile, probs = 0.1, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci90_sim2 := apply(summ_mat, 1, quantile, probs = 0.9, na.rm = TRUE)]
      }
    }
    r2Sp_ls[[sp]] <- list(r2_sim1 = r2_sim1, r2_sim2 = r2_sim2)
  }

  oob_growth <- do.call(rbind, oob_list)
  rm(oob_list, db, sampledIndices)

```

```{r calculate R2 from random forest and LMM,echo=FALSE,warning=FALSE}
  # Variables to not consider on the model
  # Quebec
  # varsToRm <- c("relativeBA_sp", "CAUS_DEFOL", "ETAT", "state_original", "state0", "state1", "spCode", "heightMeasured",
  #               "height", "nbMeasure", "indBA", "BA_sp", "dbh1", "deltaYear", "year1", "sp_code", "SHAPE",
  #               "mort", "obs", "slope_cl", "x", "y", "maxRadius", "neighborBA2", "PH_HORIZB", "POURCPIERR", 
  #               "ORIGINE", "ORIGINE2", "PERTURB", "PERTURB2", "state", "DEFOL_MAX", "ENSOLEIL")

  # US
  varsToRm <- c("relativeBA_sp", "org_db_loc",
                "height", "real_lon", "real_lat", "indBA", "BA_sp", "plot_size", "dbh1", "deltaYear", "year1", 
                "is_dead", "mort", "nbMeasure")

  rf_coeff <- data.table()
  for(sp in spIds)
  {
      # data from species
      db <- growth_dt[species_id == sp, setdiff(names(growth_dt), varsToRm), with = FALSE]

      # Split into training/validation data
      sampledIndices <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/sampledIndices_sim1.RDS'))
      db_training <- na.omit(db[sampledIndices, ])
      db_validation <- na.omit(db[!sampledIndices, ])

      # run random forest with training data
      rf_sp <- ranger(growth ~ ., data = db_training)
      
      # predict with validation data
      db_validation$growth_pred_rf <- predict(rf_sp, db_validation, type = "response")$predictions
      rf_summary <- lm(growth_pred_rf ~ growth, db_validation)
      
      # run lmm with training data
      lmm_sp <- lmer(growth ~ 1 + (1 | plot_id) +
                              (1 | year0) + (1 | plot_id:year0) +
                              (BA + dbh0 + I(dbh0^2)) * (mean_temp_period_3_lag + I(mean_temp_period_3_lag^2) +
                                  tot_annual_pp_lag + I(tot_annual_pp_lag^2)), data = db_training, REML = TRUE)

      # predict with validation data
      db_validation$growth_pred_lmm <- predict(lmm_sp, newdata = db_validation, allow.new.levels = TRUE)
      lmm_summary <- lm(growth_pred_lmm ~ growth, db_validation)

      # squared error
      db_validation[, sqErr_rf := (growth - growth_pred_rf)^2]
      db_validation[, sqErr_lmm := (growth - growth_pred_lmm)^2]

      # growth variance (total variation)
      db_validation[, gVar := (growth - mean(growth))^2]
    
      # Mean Squared Error (MSE)
      db_validation[, mean(sqErr_rf)]
    
      rf_coeff <- rbind(rf_coeff,
                        data.table(species_id = sp,
                                  Int_rf = rf_summary$coefficients[[1]],
                                  Slope_rf = rf_summary$coefficients[[2]],
                                  R2_rf = summary(rf_summary)$r.squared,
                                  MSE_rf = db_validation[, mean(sqErr_rf)],
                                  Int_lmm = lmm_summary$coefficients[[1]],
                                  Slope_lmm = lmm_summary$coefficients[[2]],
                                  R2_lmm = summary(lmm_summary)$r.squared,
                                  MSE_lmm = db_validation[, mean(sqErr_lmm)])
      )
  }
```


```{r plot OOB predictions,echo=FALSE,fig.height = 8, fig.width = 12}
  
  # prepare table to save lm() info from the simulations
  n <- length(spIds) * (length(simulations) + 2)
  reg_dt <- data.table(species_id = rep(spIds, (length(simulations) + 2)), sim = character(n), R2 = numeric(n), Slope = numeric(n))
  
  for(sp in spIds)
  {
    # axis limites
    maxGrowth <- oob_growth[species_id == sp, quantile(growth, probs = .975)]
    
    par(mfcol = c(2, length(simulations)), xaxs = "i", las = 1, mar = c(4, 4, 1, 1), oma = c(7, 5, 7, .5), mgp = c(1, 2.5, 0), tck = -.008, cex.lab = 4, cex.axis = 4, cex = 0.3)
  
    # regression (pred ~ real growth)
    reg_sim1 <- lm(Gdet_mean_sim1 ~ growth, data = oob_growth[species_id == sp])
    reg_sim2 <- lm(Gdet_mean_sim2 ~ growth, data = oob_growth[species_id == sp])
    rf_coeffSp <- rf_coeff[species_id == sp, ]

    # add to reg table
    reg_dt[species_id %in% sp, `:=`(sim = c(simulations, 'randomForest', 'LMM'),
                                  R2 = c(summary(reg_sim1)$r.squared, summary(reg_sim2)$r.squared, rf_coeffSp$R2_rf, rf_coeffSp$R2_lmm),
                                  Slope = c(reg_sim1$coefficients[[2]], reg_sim2$coefficients[[2]], rf_coeffSp$Slope_rf, rf_coeffSp$Slope_lmm))]

    # legend
    leg <- c('1:1 line',
              latex2exp::TeX(paste0('LMM: R^2 = ', round(reg_dt[species_id == sp & sim == 'LMM', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'LMM', Slope], 2))),
              latex2exp::TeX(paste0('randomForest: R^2 = ', round(reg_dt[species_id == sp & sim == 'randomForest', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'randomForest', Slope], 2))),
              latex2exp::TeX(paste0('Bayesian sim1: R^2 = ', round(reg_dt[species_id == sp & sim == 'sim1', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'sim1', Slope], 2))),
              latex2exp::TeX(paste0('Bayesian sim2: R^2 = ', round(reg_dt[species_id == sp & sim == 'sim2', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'sim2', Slope], 2))))
    
    for(sim in simulations)
    {
      # sample 10% of data
      dbAll <- oob_growth[species_id == sp, c('growth', grep(sim, names(oob_growth), value = TRUE)), with = FALSE]
      db <- dbAll[sample(1:nrow(dbAll), floor(nrow(dbAll) * 0.1))]

      # plot deterministic growth
      plot(db[, c('growth', paste0('Gdet_mean_', sim)), with = FALSE], xlim = c(0, maxGrowth), ylim = c(0, maxGrowth), pch = 20, col = rgb(0, 0, 0, 0.3), xlab = '', ylab = '', xaxt = 'n', yaxt = ifelse(sim == 'sim1', "s", "n"))
      axis(1, labels = NA)
      if(sim == 'sim2') axis(2, labels = NA)
      abline(0, 1)
      segments(db$growth - 0.01, db[[3]], db$growth + 0.01, db[[3]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth - 0.01, db[[4]], db$growth + 0.01, db[[4]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth , db[[3]], db$growth, db[[4]], col = rgb(0, 0, 0, 0.2)) # vertica
      abline(get(paste0('reg_', sim)), lty = 2)
      abline(rf_coeffSp[species_id == sp]$Int_rf, rf_coeffSp[species_id == sp]$Slope_rf, lty = 3)
      abline(rf_coeffSp[species_id == sp]$Int_lmm, rf_coeffSp[species_id == sp]$Slope_lmm, lty = 4)
      if(sim == 'sim1') legend('topleft', legend = leg, lty = c(1, 4, 3, 2, 2), cex = 2.8, bty = 'n')
      mtext(ifelse(sim == 'sim1', paste('sim1:', sim1name), paste('sim2:', sim2name)), 3, at = 3, cex = 1, line = 0.25)


      # plot gorwth with individual variation
      plot(db[, c('growth', paste0('Gvar_mean_', sim)), with = FALSE], xlim = c(0, maxGrowth), ylim = c(0, maxGrowth), col = rgb(0, 0, 0, 0.3), xlab = '', ylab = '', yaxt = ifelse(sim == 'sim1', "s", "n"))
      axis(2, labels = NA)
      abline(0, 1)
      segments(db$growth - 0.01, db[[6]], db$growth + 0.01, db[[6]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth - 0.01, db[[7]], db$growth + 0.01, db[[7]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth , db[[6]], db$growth, db[[7]], col = rgb(0, 0, 0, 0.2)) # vertica
      abline(get(paste0('reg_', sim)), lty = 2)
      abline(rf_coeffSp[species_id == sp]$Int_rf, rf_coeffSp[species_id == sp]$Slope_rf, lty = 3)
      abline(rf_coeffSp[species_id == sp]$Int_lmm, rf_coeffSp[species_id == sp]$Slope_lmm, lty = 4)

      # text
      mtext(sp, 3, outer = TRUE, cex = 1, line = 2.5)
      mtext('Deterministic growth (mean)', 3, outer = TRUE, cex = 1, line = -0.5)
      mtext('Ind variable growth', 3, outer = TRUE, cex = 1, line = -60)
      mtext('Observed growth rate (mm/y)', 1, outer = TRUE, line = 1.3, cex = 1)
      mtext('Predicted growth rate (mm/y)', 2, las = 0, outer = TRUE, line = 2.2, cex = 1)
    }
  }
```

```{r oob predictions r2, echo = FALSE,fig.height = 6, fig.width = 7, warning=FALSE, message=FALSE}
reg_dt %>%
  mutate(species_id = forcats::fct_reorder(species_id, R2)) %>% 
  ggplot(mapping = aes(x = species_id, y = R2, fill = sim, color = sim)) +
  geom_point() +
  coord_flip()
```

# Mean squared error (MSE) of out-of-bag predictions

Density distribution draws from the posterior distribution ($n = 200$) can be compared with the MSE values using the random forest methods (vertical bars).
Furthermore, I added the `sim_full` MSE when running the random forest with all non-correlated variables to get the maximum explicability from data.

```{r calculate MSE, echo = FALSE}

  #################################
  # Get X random values from posterior distribution to get a distribution of MSE (mean squared error)
  #################################

  # growth model
  growth_model3 <- function(param, sim, D, TP, PP, C, BA, plot_id, indVar = FALSE)
  {
    lgPart <- (log(D/param["Phi_opt"])/param["sigmaPhi_opt"])^2

    # competition
    if(sim == 'sim1')
    {
      compEffect <- exp(-((BA^2)/2*param["sigma_C"]^2))
    }else{
      compEffect <- (param['Lo'] + ((1 - param['Lo']) / (1 + exp(-0.45 * (C)))))
    }


    if(indVar) {
      pdg_pop <- param["pdg"] + rnorm(length(D), param[paste0('pdg_pmean[', plot_id, ']')], param["pdg_psd"])
      pdg_pop[pdg_pop <= 0] = 0.0001
    }else{
      pdg_pop <- param["pdg"] + param[paste0('pdg_pmean[', plot_id, ']')]
    } 
        
    mu_d <- pdg_pop *
            compEffect *
            exp(-0.5*(TP - param["T_opt"])^2/param["sigmaT_opt"]^2) *
            exp(-0.5*(PP - param["P_opt"])^2/param["sigmaP_opt"]^2) *
            exp(-lgPart)

    if(!indVar)
    {
      growth <- mu_d
    }else {
      growth <- rgamma(length(mu_d), mu_d^2/param["sigma_base"], mu_d/param["sigma_base"])
    }

    return( growth )
  }

  MSE_dt <- data.table()
  sampleN <- 200

  for(sp in spIds)
  {    
    db <- oob_growth[species_id == sp, .(growth, dbh0, mean_temp_period_3_lag, tot_annual_pp_lag, canopyDistance, BA, plot_id_seq)]

    for(sim in simulations)
    {
      # get params
      fit <- get(paste('fit', sim, sp, sep = '_'))
      posterior <- rstan::extract(fit)
      
    # sample X random values from posterior dist
      # First sample for the random effect parameters and rename them
      pdg_pars <- lapply(lapply(seq_len(ncol(posterior[['pdg_pmean']])), function(i) posterior[['pdg_pmean']][,i]), sample, sampleN)
      names(pdg_pars) <- paste0('pdg_pmean[', 1:length(pdg_pars), ']')

      # sample the remaining parameters and merge with pdg_ random effect
      params <- lapply(posterior[-which(names(posterior) == 'pdg_pmean')], sample, sampleN)
      params <- append(params, pdg_pars)

      MSE_det <- MSE_var <- r2 <- numeric(sampleN)
      for(i in 1:sampleN)
      {
        # get pars for one sample
        parsI <- unlist(lapply(params, `[[`, i))

        if(sim == 'sim1')
        {
          # get deterministic growth rate
          db[, g_det_pred := growth_model3(param = parsI, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]
          # get growth rate with individual variation
          db[, g_var_pred := growth_model3(param = parsI, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = TRUE)]
        }else{
            # get deterministic growth rate
          db[, g_det_pred := growth_model3(param = parsI, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = FALSE)]
          # get growth rate with individual variation
          db[, g_var_pred := growth_model3(param = parsI, sim, D = dbh0, TP = mean_temp_period_3_lag, PP = tot_annual_pp_lag, C = canopyDistance, BA = BA, plot_id = plot_id_seq, indVar = TRUE)]
        }

        # calculate MSE
        MSE_det[i] <- mean(db[, (growth - g_det_pred)^2])
        MSE_var[i] <- mean(db[, (growth - g_var_pred)^2])

        # Calculate R2 (Gelman et al 2018)
        # Doing for det_growth only as it considers the sigma_base parameter in the R2 equation
        
        # Variance of modelled predictive means
        varPred <- db[, var(g_det_pred)]
        # Variance of modelled residual
        var_res <- parsI['sigma_base']
        # Rsquared = varPred/(varPred + var_res)      
        r2[i] <- varPred/(varPred + var_res)

      }

      # update main dt
      MSE_dt <- rbind(
        MSE_dt, 
        data.table(
          species_id = sp,
          sim = sim,
          MSE_det = MSE_det,
          MSE_var = MSE_var,
          r2 = r2
        )
      )
    }
  }

```

```{r plot MSE,echo=FALSE,fig.height = 6, fig.width = 8, warning=FALSE, message=FALSE}
  
  # Rename rf_coeff for legend
  rf_coeff_lg <- rf_coeff %>%
                  pivot_longer(!species_id, names_to = 'Method', values_to = 'value') %>%
                  mutate(
                    Method = plyr::revalue(
                      Method,
                      c('MSE_rf' = 'Random forest', 'MSE_lmm' = 'LMM')
                    )
                  )

  # For deterministic growth
  ggplot(data = MSE_dt, aes(MSE_det, species_id, fill = sim, colour = sim)) + 
    geom_density_ridges(alpha = 0.4, scale= 1.8) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'Random forest'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'LMM'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    xlim(0, 7.6) +
    theme_classic() +
    ggtitle('Deterministic growth') +
    xlab('MSE') +
    scale_y_discrete(limits = rev(spIds))


  # For ind variation growth
    ggplot(data = MSE_dt, aes(MSE_var, species_id, fill = sim, colour = sim)) + 
      geom_density_ridges(alpha = 0.4, scale= 1.8) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'Random forest'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'LMM'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    xlim(0, 7.6) +
    theme_classic() +
    ggtitle('Ind variable growth') +
    xlab('MSE') +
    scale_y_discrete(limits = rev(spIds))

```


# Rsquared

Rsquared values draw from the posterior distribution is calculated using the Gelman et al. [2018](http://www.stat.columbia.edu/~gelman/research/unpublished/bayes_R2.pdf) definition.
Like MSE, the $R^{2}$ can be compared with the ones from the random forest using the same variables along with the full model (`sim_full`). However, the $R^{2}$ of the random forest is calculated using the classical equation.

```{r plot Rsquared,echo=FALSE,fig.height = 6, fig.width = 8, warning=FALSE, message=FALSE}
  
  # load random forest MSE information
  rf_coeff_r2 <- rf_coeff_lg %>%
                 dplyr::filter(Method %in% c('R2_rf', 'R2_lmm')) %>%
                 mutate(Method = plyr::revalue(Method, c('R2_rf' = 'Random forest', 'R2_lmm' = 'LMM')))

  # For deterministic growth
  ggplot(data = MSE_dt, aes(r2, species_id, fill = sim, colour = sim)) + 
    geom_density_ridges(alpha = 0.4, scale= 1.8) +
    geom_segment(data = subset(rf_coeff_r2, Method == 'Random forest'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    geom_segment(data = subset(rf_coeff_r2, Method == 'LMM'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    xlim(0, 1) +
    theme_classic() +
    xlab('Rsquared') +
    scale_y_discrete(limits = rev(spIds))

```


# Population summary

```{r popSummary, echo = FALSE,fig.height = 6, fig.width = 8, warning=FALSE, message=FALSE}

params <- rstan::extract(get(paste0('fit_', sim, '_', sp)))

p1 <- oob_growth %>%
  select(species_id, 'growth', contains('Gvar')) %>%
  pivot_longer(
    cols = starts_with('G'),
    names_to = 'pars',
    values_to = 'value'
  )  %>%
  mutate(
    pars = recode(
      pars,
      Gvar_mean_sim1 = 'Gvar_sim1',
      Gvar_ci10_sim1 = 'Gvar_sim1',
      Gvar_ci90_sim1 = 'Gvar_sim1',
      Gvar_mean_sim2 = 'Gvar_sim2',
      Gvar_ci10_sim2 = 'Gvar_sim2',
      Gvar_ci90_sim2 = 'Gvar_sim2'
    )
  ) %>%
  ggplot(aes(x = value, y = species_id, fill = pars)) +
    geom_density_ridges(alpha = 0.4) +
    xlim(0, 7) +
    xlab('Growth')

print(p1)
```


# Sampling time

```{r sampling time, echo = FALSE}
samplingDF <- data.frame()

for(sim in simulations) {
  for(sp in spIds) {
    simNames <- paste('fit', sim, sp, sep = '_')
    sumTime <- rowSums(get_elapsed_time(get(simNames)))
    nChain <- length(sumTime)
    df1 <- data.frame(sim = rep(sim, nChain),
                     sp = rep(sp, nChain),
                     time = sumTime)
    samplingDF <- rbind(samplingDF, df1)
  }
}

samplingDF$time <- samplingDF$time/60/60
```

```{r plot sampling time, echo = FALSE, fig.height = 6, fig.width = 12}

p <- ggplot(data = samplingDF, aes(x = sim, y = time)) +
      geom_boxplot() +
      facet_grid(~sp) +
      theme_classic() +
      ylab('Time (h)')
print(p)
```
```{r plot sampling time2, echo = FALSE, fig.height = 5, fig.width = 6}
p <- ggplot(data = samplingDF, aes(x = sim, y = time)) +
      geom_boxplot() +
      theme_classic() +
      ylab('Time (h)')
print(p)
```

---
 title: "MCMC diagnostics - Growth"
 subtitle: "Test v9.0 - Canopy Distance 3 pars vs Basal area"
 author: "Will Vieira"
 date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---


## Compare the convergence of the model using the `canopyDistance` predictor as the competition effect:

- sim1: sigmoid with `Lo` [0-1], `mid` [0.1 - 0.5], and `beta` [-10 - 10] parameters
- sim2: BA with simple negative exponential

```{r, echo = F, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggpubr))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(require(RColorBrewer))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(ranger))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(MuMIn))
```
```{r load simulations, echo = F}
# Load simulation variables
  simInfo <- yaml::read_yaml('_simulation_info.yml')

  # species id
  if(is.null(simInfo$spIds)) {
    spIds <- readRDS('data/spIds.RDS')
  }else {
    spIds <- simInfo$spIds
  }

  simName <- simInfo$simName

  simulations <- simInfo$simulations

  # Human readble simName
  sim1name <- 'canopy distance'
  sim2name <- 'basal area'

#


# Load rStan output and scaleInfo for all species_id
  # get output name for each species_id
  simNames = list.files(path = paste0('output/', simName), pattern = '.RDS', recursive = TRUE, full.names = TRUE)
  output = simNames[grep('growthMCMC', simNames)]

  for(sim in simulations) {
    for(sp in spIds) {
      fileName <- output[grep(paste0(sim, sp), output)]
      assign(paste('fit', sim, sp, sep = '_'), readRDS(fileName))
    }
  }

  # get name of parameters for each simulation
  for(sim in simulations)
    assign(paste0('pars_', sim), rownames(summary(get(ls(pattern = sim)[1]))[[1]]))

```



# Rhat

```{r, echo = F, fig.height = 6, fig.width = 10}

  # number of parameters for all simulations
  nbParams <- prod(unlist(lapply(as.list(paste0('pars_', simulations)), function(x) length(get(x)))))
  # create a table with Rhat for each parameter (clumn) and species_id (Rhat)
  Rhat <- data.frame()
  count = 1
  for(sim in simulations) {
    for(sp  in spIds) {
      df <- summary(get(paste('fit', sim, sp, sep = '_')))$summary
      dfToAdd <- data.frame(
          sim, 
          sp,
          rownames(df),
          df[, 'Rhat'],
          row.names = NULL
      )
      Rhat <- rbind(Rhat, dfToAdd)
    }
  }
  names(Rhat) <- c('sim', 'sp', 'pars', 'Rhat')

  p <- ggplot(data = Rhat, aes(x = sp, y = Rhat)) +
       geom_boxplot() +
       coord_flip() +
       facet_grid(~sim, scales = 'free_x',
                 labeller = labeller(sim = setNames(c(sim1name, sim2name),
                                     c('sim1', 'sim2'
                                    )))) +
       theme_classic()
  print(p)
```



# Divergent transitions

```{r divergent transitions, echo = FALSE}

divergentDF <- data.frame(matrix(NA, ncol = 3))
names(divergentDF) <- c('sim', 'sp', 'divergent')

count = 1
for(sim in simulations) {
  for(sp in spIds) {
    simNames <- paste('fit', sim, sp, sep = '_')
    sampler_params <- get_sampler_params(get(simNames), inc_warmup = FALSE)
    nbDivergent <- sum(unlist(lapply(sampler_params, function(mat) mat[, 'divergent__'])))
    divergentDF[count, ] <- c(sim, sp, nbDivergent)
    count = count + 1
  }
}
```

```{r divergent table, echo = FALSE}
DT::datatable(divergentDF)
```



# Density plot of each parameter by species id

```{r get MCMC sampling data, eval = TRUE,echo = F}
    
  # extact parameter summary for all sp * simulations
  ext_summ <- function(fit)
    summary(get(fit))$summary[, 4:8] %>%
      as.data.frame() %>%
      rownames_to_column(var = 'param')
      
  params_summ = map_df(
    setNames(
      as.list(grep('fit_', ls(), value = TRUE)),
      grep('fit_', ls(), value = TRUE)
    ),
    ext_summ,
    .id = 'sp_sim'
  ) %>%
  rowwise() %>%
  mutate(
    sim = unlist(strsplit(sp_sim, '_'))[2],
    sp = unlist(strsplit(sp_sim, '_'))[3]
  ) %>%
  select(-1)


  # function to plot parameter distribution
  plot_parDist <- function(par_dt)
  {
    spIds <- unique(par_dt$sp)  
    sims <- unique(par_dt$sim)

    xLim <- range(par_dt[, 2:6])
    yLim <- c(0.75, length(spIds) - 0.75)

    simCols <- setNames(
      c(
        rgb(221, 170, 51, maxColorValue = 255),
        rgb(187,85, 102, maxColorValue = 255)
      ),
      sims
    )

    par(xaxs = "i", las = 1, mar = c(2.5, 2, 1.5, 1.5), oma = c(1, 4, 2, .2), mgp = c(1.5, 0.3, 0), tck = -.008, cex.lab = 1.2, cex.axis = 1.2)

    plot(0, pch = '', yaxt = 'n', xlim = xLim, ylim = yLim, xlab = unique(par_dt$param), ylab = '')
    for(Sp in 1:length(spIds))
    {
      for(Sim in sims)
      {
        par_spSim <- subset(par_dt, sp == spIds[Sp] & sim == Sim)
        par_spSim <- apply(par_spSim[, 2:6], 2, mean)
        segments(
          x0 = par_spSim['2.5%'],
          y0 = Sp + ifelse(Sim == 'sim1', +0.15, -0.15),
          x1 = par_spSim['97.5%'],
          y1 = Sp + ifelse(Sim == 'sim1', +0.15, -0.15),
          col = simCols[Sim],
          lwd = 2
        )
        segments(
          x0 = par_spSim['25%'],
          y0 = Sp + ifelse(Sim == 'sim1', +0.15, -0.15),
          x1 = par_spSim['75%'],
          y1 = Sp + ifelse(Sim == 'sim1', +0.15, -0.15),
          col = simCols[Sim],
          lwd = 4
        )
      }
      abline(h = Sp + 0.5, lty = 2, col = rgb(0, 0, 0, 0.2))
    }
    axis(2, at = 1:length(spIds), labels = gsub('[0-9]', '', spIds))
    legend('bottomright', legend = sims, col = simCols, bty = 'n', pch = 19)
  }

```

```{r plot mcmcSample by pars, eval = T,echo = F, message=FALSE, fig.height = 7, fig.width = 7}

all_pars <- unique(params_summ$param)
fixed_pars <- grep(
  'pdg_pmean',
  all_pars,
  value = TRUE,
  invert = TRUE
)
random_pars <- setdiff(all_pars, fixed_pars)


for(Par in fixed_pars)
  plot_parDist(subset(params_summ, param == Par))

plot_parDist(subset(params_summ, param %in% random_pars))
```

# Data distribution

```{r organize data, echo = FALSE}
growth_dt <- readRDS('data/growth_dt.RDS')
growth_dt <- growth_dt[species_id %in% spIds]
growth <- growth_dt[, .(plot_id, species_id, growth, dbh0, deltaYear, bio_01, bio_12, canopyDistance)]

# transform dt
growth <- tidyr::gather(data = growth,
            growth, dbh0, bio_01, bio_12, canopyDistance,
            key = 'var', value = 'value')
```

```{r plot data distribution, echo = FALSE, message=FALSE, fig.height = 7, fig.width = 10}
ggplot(data = growth, aes(value, species_id)) +
      geom_density_ridges_gradient() +
      facet_grid(~var, scales = 'free_x') + #,
      #          labeller = labeller(sim = setNames(c(sim1name,
      #                              sim2name),
      #                              c('sim1', 'sim2')))) +
      theme_classic()
rm(growth)
```


# Size, temperature, precipitation and competition effect

```{r, echo = F, fig.height = 13, fig.width = 9}
# Plot of size, temperature, precipitation and competition effect

  # define functions of the model
    # size effect
    sizeEffect = function(x, Phi_opt, sigmaPhi_opt) {
      lgPart <- (log(x/Phi_opt)/sigmaPhi_opt)^2
      return( exp(-lgPart))
    }

    # temperature effect
    tempEffect = function(xtemp, T_opt, sigmaT_opt) {
      return(0.0001 + exp(-0.5*(xtemp - T_opt)^2/sigmaT_opt^2))
    }

    # precipitation effect
    precEffect = function(xprec, P_opt, sigmaP_opt) {
      return(exp(-0.5*(xprec - P_opt)^2/sigmaP_opt^2))
    }

    compEffect = function(x, params, sim) {
      if(sim == 'sim1') {
        return( (params['Lo', 1] + ((1 - params['Lo', 1]) / (1 + exp(-params['beta', 1] * (x - params['mid', 1]))))) )
      }else{
        return( exp(-((x^2)/2 * params['sigma_C', 1]^2)) )
      }
    }

  #

  ## PLOT ##

 # define x axis
  sizex = seq(0, 1100, 0.5)
  tempx = seq(-8, 24, 0.1)
  precx = seq(100, 2000)

  # species specfic colours
  spCols <- colorRampPalette(RColorBrewer::brewer.pal(12, "Set3"))(length(spIds))
  par(mfrow = c(4, length(simulations)), xaxs = "i", las = 1, mar = c(3, 1, 1.5, 1.5), oma = c(1,3.5,2,.2), mgp = c(1.5, 0.3, 0), tck = -.008, cex.lab = 1.2, cex.axis = 1.2)
  # plot size effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary
      # plot
      if(sp == 1) plot(sizex, sizeEffect(sizex, out['Phi_opt', 1], out['sigmaPhi_opt', 1]),
                  type = 'l', ylim = c(0, 1), xlab = 'Size (mm)', ylab = 'Size effect',
                  col = spCols[sp],
                  yaxt = ifelse(sim == 'sim1', "s", "n"))
      if(sim == 'sim2') axis(2, labels = FALSE)
      xData = growth_dt[species_id == spIds[sp], seq(min(dbh0), max(dbh0), 0.5)]
      points(sizex, sizeEffect(sizex, out['Phi_opt', 1], out['sigmaPhi_opt', 1]), type = 'l', col = spCols[sp], lwd = 0.8, lty = 2)
      points(xData, sizeEffect(xData, out['Phi_opt', 1], out['sigmaPhi_opt', 1]), type = 'l', col = spCols[sp], lwd = 1, lty = 1)
    }
    mtext(ifelse(sim == 'sim1', paste0('sim: ', sim1name), paste0('sim: ', sim2name)), side = 3, line = 0)
    if(sim == 'sim1') mtext("Size effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot temp effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary
      topt <- out['T_opt', 1]
      sigTopt <- out['sigmaT_opt', 1]

      if(sp == 1) plot(tempx, tempEffect(tempx, topt, sigTopt), type = 'l',
                  ylim = c(0, 1), xlab = 'Annual mean temperature period 3 (Â°C)', ylab = 'Temperature effect',
                  col = spCols[sp],
                  yaxt = ifelse(sim == 'sim1', "s", "n"))
      if(sim == 'sim2') axis(2, labels = FALSE)
      xData = growth_dt[species_id == spIds[sp], seq(min(bio_01), max(bio_01), 0.1)]
      points(tempx, tempEffect(tempx, topt, sigTopt), type = 'l', col = spCols[sp], lwd = 0.8, lty = 2)
      points(xData, tempEffect(xData, topt, sigTopt), type = 'l', col = spCols[sp], lwd = 1, lty = 1)
    }
    if(sim == 'sim1') mtext("Temperature effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot precipitation effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary
      popt <- out['P_opt', 1]
      sigPopt <- out['sigmaP_opt', 1]

      if(sp == 1) plot(precx, precEffect(precx, popt, sigPopt), type = 'l',
                  ylim = c(0, 1), xlab = 'Precipiation (mm)', ylab = 'Precipiation effect',
                  col = spCols[sp],
                  yaxt = ifelse(sim == 'sim1', "s", "n"))
      if(sim == 'sim2') axis(2, labels = FALSE)
      xData = growth_dt[species_id == spIds[sp], seq(min(bio_12), max(bio_12), 1)]
      points(precx, precEffect(precx, popt, sigPopt), type = 'l', col = spCols[sp], lwd = 0.8, lty = 2)
      points(xData, precEffect(xData, popt, sigPopt), type = 'l', col = spCols[sp], lwd = 1, lty = 1)
    }
    if(sim == 'sim1') mtext("Precipiation effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot competition effect
  for(sim in simulations) {
    for(sp in 1:length(spIds)) {
      # get parameters
      out <- summary(get(paste('fit', sim, spIds[sp], sep = '_')))$summary

      if(sim == 'sim1') {
        x = seq(-35, 45, 0.1)
      }else{
        x = seq(0, 100, 0.1)
      }

      if(sp == 1) 
        plot(x, compEffect(x, out, sim),
            ylim = c(0, 1), type = 'l', xlab = ifelse(sim == 'sim1', 'Canopy distance', 'Basal area'), ylab = 'Competition effect',
            col = spCols[sp],
            yaxt = ifelse(sim == 'sim1', "s", "n")
        )
        if(sim == 'sim2') axis(2, labels = FALSE)
        if(sim == 'sim1') {
          xData = growth_dt[species_id == spIds[sp], seq(min(canopyDistance), max(canopyDistance), .1)]
        }else{
          xData = growth_dt[species_id == spIds[sp], seq(min(BA), max(BA), .1)]
        }
        points(x, compEffect(x, out, sim), type = 'l', col = spCols[sp], lwd = 0.8, lty = 2)
        points(xData, compEffect(xData, out, sim), type = 'l', col = spCols[sp], lwd = 1, lty = 1)
    }
    if(sim == 'sim1') mtext("Competition effect", 2, las = 0, cex = .8, line = 1.9)
    if(sim == 'sim1')
      legend('bottomright', legend = spIds, col = spCols, lty = 1, bty = 'n', cex = 0.9)
  }

```


# Predictions

```{r,echo=FALSE,fig.height = 15.5, fig.width = 12}
growth_model <- function(sp, sim, pars, D, TP, PP, CD, indVar = FALSE)
{

  # loop to get growth in function of parameter mean, 10 or 90%
  growth_ls <- list()
  for(i in c('mean', 'ci10', 'ci90'))
  {
    param <- pars[[paste0('param_', i)]]

    lgPart <- (log(D/param["Phi_opt"])/param["sigmaPhi_opt"])^2

    if(sim == 'sim1') {
      compEffect <- (param['Lo'] + ((1 - param['Lo']) / (1 + exp(-param['beta'] * (CD - param['mid'])))))
    }else{
      compEffect <- exp(-((CD^2)/2*param["sigma_C"]^2))

    }
    mu_d <- param["pdg"] *
            compEffect *
            exp(-0.5*(TP - param["T_opt"])^2/param["sigmaT_opt"]^2) *
            exp(-0.5*(PP - param["P_opt"])^2/param["sigmaP_opt"]^2) *
            exp(-lgPart)

    if(!indVar)
    {
      growth <- mu_d
    }else {
      lower <- qgamma(.95, (mu_d^2/param["sigma_base"]), mu_d/param["sigma_base"], lower.tail = FALSE)
      upper <- qgamma(.95, (mu_d^2/param["sigma_base"]), mu_d/param["sigma_base"])
      growth <- data.frame(means = mu_d, lower = lower, upper = upper)
    }

    growth_ls[[i]] <- growth
  }
  
  return( growth_ls )
}


# define classes for each predictive variables
growth_dt[, sizec := cut(dbh0, seq(min(dbh0), max(dbh0), 8)), by = species_id]
growth_dt[, tempc := cut(bio_01, seq(min(bio_01), max(bio_01), 1.5)), by = species_id]
growth_dt[, precc := cut(bio_12, seq(min(bio_12), max(bio_12), 100)), by = species_id]
growth_dt[, compsim1c := cut(canopyDistance, seq(min(canopyDistance), max(canopyDistance), 5)), by = species_id]
growth_dt[, compsim2c := cut(BA, seq(min(BA), max(BA), 5)), by = species_id]

# get the classe with max of individuals (best representative classe)
growth_dt[, maxsizec := names(which.max(table(sizec))), by = species_id]
growth_dt[, maxtempc := names(which.max(table(tempc))), by = species_id]
growth_dt[, maxprecc := names(which.max(table(precc))), by = species_id]
growth_dt[, maxcompsim1c := names(which.max(table(compsim1c))), by = species_id]
growth_dt[, maxcompsim2c := names(which.max(table(compsim2c))), by = species_id]


for(sp in spIds)
{

  # plot
  par(mfcol = c(4, length(simulations)), xaxs = "i", las = 1, mar = c(9, 4, 1.5, 1), oma = c(7, 5, 7, .5), mgp = c(6, 2.5, 0), tck = -.008, cex.lab = 4, cex.axis = 4, cex = 0.3)
  
  for(sim in c('sim1', 'sim2'))
  {  
    # get parameters
    fit <- get(paste('fit', sim, sp, sep = '_'))

    # posterior distribution
    posterior <- rstan::extract(fit)

    param_summary <- summary(fit, probs = c(0.1, 0.9))$summary
    #rownames(param_summary) <- names(posterior)
    param_summary <- param_summary[,-c(2:3)]

    # define parameters
    nRow <- nrow(param_summary)
    pars <- list(
        param_mean = param_summary[-nRow, 1],
        param_ci10 = param_summary[-nRow, 2],
        param_ci90 = param_summary[-nRow, 3]
    )

    # Size effect
    sp_dt <- growth_dt[
      species_id == sp &
      tempc == maxtempc &
      precc == maxprecc &
      compsim1c == maxcompsim1c
    ]

    x <- growth_dt[species_id == sp, seq(min(dbh0), max(dbh0), 0.1)]
    growth <- growth_model(
      sp = sp,
      sim = sim,
      pars = pars,
      D = x,
      TP = sp_dt[, mean(bio_01)],
      PP = sp_dt[, mean(bio_12)],
      CD = sp_dt[, mean(canopyDistance)]
    )

    sp_dt[, plot(dbh0, growth, pch = 19, cex = .8, col = rgb(0, 0, 0, 0.6), ylim = c(0, quantile(growth, 0.99)), xlab = 'Size (mm)', ylab = '', yaxt = ifelse(sim == 'sim1', "s", "n"))]
    polygon(
      c(x, rev(x)),
      c(growth$ci10, rev(growth$ci90)),
      col = alpha("grey25", 0.1), border = NA
    )
    points(x, growth$mean, type = 'l', lwd = 2)

    mtext(ifelse(sim == 'sim1', paste('sim1:', sim1name), paste('sim2:', sim2name)), 3, at = 225, cex = 1.2, line = 0.25)

    # temperature effect
    sp_dt <- growth_dt[
      species_id == sp &
      sizec == maxsizec &
      precc == maxprecc &
      compsim1c == maxcompsim1c
    ]

    x <- growth_dt[species_id == sp, seq(min(bio_01), max(bio_01), 0.01)]
    growth <- growth_model(
      sp = sp,
      sim = sim,
      pars = pars,
      D = sp_dt[, mean(dbh0)],
      TP = x,
      PP = sp_dt[, mean(bio_12)],
      CD = sp_dt[, mean(canopyDistance)]
    )

    sp_dt[, plot(bio_01, growth, pch = 19, cex = .8, col = rgb(0, 0, 0, 0.6), ylim = c(0, quantile(growth, 0.99)), xlab = 'Mean annual temperature (Â°C)', ylab = '', yaxt = ifelse(sim == 'sim1', "s", "n"))]
    polygon(
      c(x, rev(x)),
      c(growth$ci10, rev(growth$ci90)),
      col = alpha("grey25", 0.1), border = NA
    )
    points(x, growth$mean, type = 'l', lwd = 2)

    # Precipitation effect
    sp_dt <- growth_dt[
      species_id == sp &
      sizec == maxsizec &
      tempc == maxtempc &
      compsim1c == maxcompsim1c
    ]

    x <- growth_dt[species_id == sp, seq(min(bio_12), max(bio_12), 1)]
    growth <- growth_model(
      sp = sp,
      sim = sim,
      pars = pars,
      D = sp_dt[, mean(dbh0)],
      TP = sp_dt[, mean(bio_01)],
      PP = x,
      CD = sp_dt[, mean(canopyDistance)]
    )

    sp_dt[, plot(bio_12, growth, pch = 19, cex = .8, col = rgb(0, 0, 0, 0.6), ylim = c(0, quantile(growth, 0.99)), xlab = 'Total annual precipitation (mm)', ylab = '', yaxt = ifelse(sim == 'sim1', "s", "n"))]
    polygon(
      c(x, rev(x)),
      c(growth$ci10, rev(growth$ci90)),
      col = alpha("grey25", 0.1), border = NA
    )
    points(x, growth$mean, type = 'l', lwd = 2)

    # Competition effect
    sp_dt <- growth_dt[
      species_id == sp &
      sizec == maxsizec &
      tempc == maxtempc &
      precc == maxprecc
    ]

    if(sim == 'sim1') {
      x <- growth_dt[species_id == sp, seq(min(canopyDistance), max(canopyDistance), 0.01)]
    }else{
      x <- growth_dt[species_id == sp, seq(min(BA), max(BA), 0.01)]
    }
    growth <- growth_model(
      sp = sp,
      sim = sim,
      pars = pars,
      D = sp_dt[, mean(dbh0)],
      TP = sp_dt[, mean(bio_01)],
      PP = sp_dt[, mean(bio_12)],
      CD = x
    )

    if(sim == 'sim1') {
      sp_dt[, plot(canopyDistance, growth, pch = 19, cex = .8, col = rgb(0, 0, 0, 0.6), ylim = c(0, quantile(growth, 0.99)), xlab = 'Canopy distance (m)', ylab = '', yaxt = ifelse(sim == 'sim1', "s", "n"))]
    }else{
      sp_dt[, plot(BA, growth, pch = 19, cex = .8, col = rgb(0, 0, 0, 0.6), ylim = c(0, quantile(growth, 0.99)), xlab = 'Basal area (m2/ha)', ylab = '', yaxt = ifelse(sim == 'sim1', "s", "n"))]
    }

    polygon(
      c(x, rev(x)),
      c(growth$ci10, rev(growth$ci90)),
      col = alpha("grey25", 0.1), border = NA
    )
    points(x, growth$mean, type = 'l', lwd = 2)
  }
   mtext(sp, 3, outer = TRUE, cex = 1.3, line = 2.5)
}
```

# Out-of-bag predictions

To compare the model efficiency, we plot the 1:1, and the regression line from `lm(pred_growth ~ observed_growth)` for both Bayesian and random forest methods as reference.

```{r organize data by sp for OOB predictions,echo=FALSE,fig.height = 12, fig.width = 12}
  # create a list of data.table objects for each spIds
  # For each data.table, we will get all rows that were not used in the fitting stan model
  # I have to do it as the sampleIndices where saved when the data frame was already filtered for the specific sp

  oob_list <- list()
  for(sp in spIds)
  {
    # sp specific db
    db <- growth_dt[species_id == sp]

    # load plot_id references and update plot_id to ID_PE
    toSub <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/toSub_sim1.RDS'))
    db[toSub, on = .(plot_id), plot_id_seq := i.plot_id_seq]

    # load rows used for stan fit
    sampledIndices <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/sampledIndices_sim1.RDS'))

    db <- db[!sampledIndices, ]
    db <- db[!is.na(plot_id_seq), ]

    oob_list[[sp]] <- db[!is.na(plot_id), ]
  }
```

```{r calculate OOB predictions,echo=FALSE,fig.height = 12, fig.width = 12}

  # growth model
  growth_model2 <- function(param, sim, D, TP, PP, C, plot_id, indVar = FALSE, singleEffect = FALSE)
  {
    # size effect
    lgPart <- (log(D/param["Phi_opt"])/param["sigmaPhi_opt"])^2
    sizeEffect <- exp(-lgPart)

    # competition effect
    if(sim == 'sim1')
    {
      compEffect <- (param['Lo'] + ((1 - param['Lo']) / (1 + exp(-param['beta'] * (C - param['mid'])))))
    }else{
      compEffect <- exp(-((C^2)/2*param["sigma_C"]^2))
    }

    # Temperature effect
    tempEffect <- exp(-0.5*(TP - param["T_opt"])^2/param["sigmaT_opt"]^2)

    # Precipitation effect
    precEffect <- exp(-0.5*(PP - param["P_opt"])^2/param["sigmaP_opt"]^2)

    # if(indVar)
    # {
    #   pdg_pop <- param["pdg"] + rnorm(length(D), param[paste0('pdg_pmean[', plot_id, ']')], param["pdg_psd"])
    #   pdg_pop[pdg_pop <= 0] = 0.0001
    # }else
    # {
    #   pdg_pop <- param["pdg"] + param[paste0('pdg_pmean[', plot_id, ']')]
    # } 

    pdg_pop <- param["pdg"] + param[paste0('pdg_pmean[', plot_id, ']')]

    mu_d <- pdg_pop *
            compEffect *
            tempEffect *
            precEffect *
            sizeEffect

    if(!indVar)
    {
      growth <- mu_d
    }else {
      growth <- rgamma(length(D), (mu_d^2/param["sigma_base"]), mu_d/param["sigma_base"])
    }

    if(singleEffect) {
      return(
        list(
          growth,
          sizeEffect,
          tempEffect,
          precEffect,
          compEffect
        )
      )
    }else{
      return( growth )
    }
  }

  # loop over species and simulations
  r2Sp_ls <- list()
  sampleN <- 30

  for(sp in spIds)
  {
    for(sim in simulations)
    {
      # get params
      fit <- get(paste('fit', sim, sp, sep = '_'))
      posterior <- rstan::extract(fit)

      param_summary <- summary(fit, probs = c(0.1, 0.9))$summary
      param_summary <- param_summary[, -c(2:3)]

      nRow <- nrow(param_summary)
      param_mean <- param_summary[-nRow, 1]
      param_ci10 <- param_summary[-nRow, 2]
      param_ci90 <- param_summary[-nRow, 3]

      if(sim == 'sim1')
      {
        # get deterministic growth rate
        oob_list[[sp]][, c('Gdet_mean_sim1', 'sizeEff_sim1', 'tempEff_sim1', 'precEff_sim1', 'compEff_sim1') := growth_model2(param = param_mean, sim, D = dbh0, TP = bio_01, PP = bio_12, C = canopyDistance, plot_id = plot_id_seq, indVar = FALSE, singleEffect = TRUE)]
        oob_list[[sp]][, Gdet_ci10_sim1 := growth_model2(param = param_ci10, sim, D = dbh0, TP = bio_01, PP = bio_12, C = canopyDistance, plot_id = plot_id_seq, indVar = FALSE)]
        oob_list[[sp]][, Gdet_ci90_sim1 := growth_model2(param = param_ci90, sim, D = dbh0, TP = bio_01, PP = bio_12, C = canopyDistance, plot_id = plot_id_seq, indVar = FALSE)]

        # get growth rate with individual parameter AND individual variation
        summ_mat <- matrix(rep(0, nrow(oob_list[[sp]]) * sampleN), ncol = sampleN)
        r2_sim1 <- numeric(sampleN)
        # First sample for the random effect parameters and rename them
        pdg_pars <- lapply(lapply(seq_len(ncol(posterior[['pdg_pmean']])), function(i) posterior[['pdg_pmean']][,i]), sample, sampleN)
        names(pdg_pars) <- paste0('pdg_pmean[', 1:length(pdg_pars), ']')
        
        # sample the remaining parameters and merge with pdg_ random effect
        params <- lapply(posterior[-which(names(posterior) == 'pdg_pmean')], sample, sampleN)
        params <- append(params, pdg_pars)        
        for(i in 1:sampleN)
        {
          summ_mat[, i] <- oob_list[[sp]][, growth_model2(unlist(lapply(params, `[[`, i)), sim = sim, D = dbh0, TP = bio_01, PP = bio_12, C = canopyDistance, plot_id = plot_id_seq, indVar = TRUE)]
          r2_sim1[i] <- summary(lm(summ_mat[, i] ~ oob_list[[sp]]$growth))$r.squared
        }
        oob_list[[sp]][, Gvar_mean_sim1 := apply(summ_mat, 1, mean, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci10_sim1 := apply(summ_mat, 1, quantile, probs = 0.1, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci90_sim1 := apply(summ_mat, 1, quantile, probs = 0.9, na.rm = TRUE)]
  
      }else{
          # get deterministic growth rate
        oob_list[[sp]][, c('Gdet_mean_sim2', 'sizeEff_sim2', 'tempEff_sim2', 'precEff_sim2', 'compEff_sim2') := growth_model2(param = param_mean, sim, D = dbh0, TP = bio_01, PP = bio_12, C = BA, plot_id = plot_id_seq, indVar = FALSE, singleEffect = TRUE)]
        oob_list[[sp]][, Gdet_ci10_sim2 := growth_model2(param = param_ci10, sim, D = dbh0, TP = bio_01, PP = bio_12, C = BA, plot_id = plot_id_seq, indVar = FALSE)]
        oob_list[[sp]][, Gdet_ci90_sim2 := growth_model2(param = param_ci90, sim, D = dbh0, TP = bio_01, PP = bio_12, C = BA, plot_id = plot_id_seq, indVar = FALSE)]

        # get growth rate with individual parameter AND individual variation
        summ_mat <- matrix(rep(0, nrow(oob_list[[sp]]) * sampleN), ncol = sampleN)
        r2_sim2 <- numeric(sampleN)
        # First sample for the random effect parameters and rename them
        pdg_pars <- lapply(lapply(seq_len(ncol(posterior[['pdg_pmean']])), function(i) posterior[['pdg_pmean']][,i]), sample, sampleN)
        names(pdg_pars) <- paste0('pdg_pmean[', 1:length(pdg_pars), ']')
        # sample the remaining parameters and merge with pdg_ random effect
        params <- lapply(posterior[-which(names(posterior) == 'pdg_pmean')], sample, sampleN)
        params <- append(params, pdg_pars)

        for(i in 1:sampleN)
        {
          summ_mat[, i] <- oob_list[[sp]][, growth_model2(unlist(lapply(params, `[[`, i)), sim = sim, D = dbh0, TP = bio_01, PP = bio_12, C = BA, plot_id = plot_id_seq, indVar = TRUE)]
          r2_sim2[i] <- summary(lm(summ_mat[, i] ~ oob_list[[sp]]$growth))$r.squared
        }
        oob_list[[sp]][, Gvar_mean_sim2 := apply(summ_mat, 1, mean, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci10_sim2 := apply(summ_mat, 1, quantile, probs = 0.1, na.rm = TRUE)]
        oob_list[[sp]][, Gvar_ci90_sim2 := apply(summ_mat, 1, quantile, probs = 0.9, na.rm = TRUE)]
      }
    }
    r2Sp_ls[[sp]] <- list(r2_sim1 = r2_sim1, r2_sim2 = r2_sim2)
  }

  oob_growth <- do.call(rbind, oob_list)
  rm(oob_list, db, sampledIndices)

```

```{r calculate R2 from random forest and LMM,echo=FALSE,warning=FALSE}

  varsToRm <- c("relativeBA_sp", "db_origin", "dbh1",
                "height", "indBA", "BA_sp", "plot_size",
                "deltaYear", "deltaDbh", "year1", "status")

  rf_coeff <- data.table()
  for(sp in spIds)
  {
      # data from species
      db <- growth_dt[species_id == sp, setdiff(names(growth_dt), varsToRm), with = FALSE]

      # Split into training/validation data
      sampledIndices <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/sampledIndices_sim1.RDS'))
      db_training <- na.omit(db[sampledIndices, ])
      db_validation <- na.omit(db[!sampledIndices, ])

      # run random forest with training data
      rf_sp <- ranger(growth ~ ., data = db_training)
      
      # predict with validation data
      db_validation$growth_pred_rf <- predict(rf_sp, db_validation, type = "response")$predictions
      rf_summary <- lm(growth_pred_rf ~ growth, db_validation)
      
      # run lmm with training data
      lmm_sp <- lmer(growth ~ 1 + (1 | plot_id) +
                              (1 | year0) + (1 | plot_id:year0) +
                              (BA + dbh0 + I(dbh0^2)) * (bio_01 + I(bio_01^2) +
                                  bio_12 + I(bio_12^2)), data = db_training, REML = TRUE)

      # predict with validation data
      db_validation$growth_pred_lmm <- predict(lmm_sp, newdata = db_validation, allow.new.levels = TRUE)
      lmm_summary <- lm(growth_pred_lmm ~ growth, db_validation)

      # squared error
      db_validation[, sqErr_rf := (growth - growth_pred_rf)^2]
      db_validation[, sqErr_lmm := (growth - growth_pred_lmm)^2]

      # growth variance (total variation)
      db_validation[, gVar := (growth - mean(growth))^2]
    
      # Mean Squared Error (MSE)
      db_validation[, mean(sqErr_rf)]
    
      rf_coeff <- rbind(rf_coeff,
                        data.table(species_id = sp,
                                  Int_rf = rf_summary$coefficients[[1]],
                                  Slope_rf = rf_summary$coefficients[[2]],
                                  R2_rf = summary(rf_summary)$r.squared,
                                  MSE_rf = db_validation[, mean(sqErr_rf)],
                                  Int_lmm = lmm_summary$coefficients[[1]],
                                  Slope_lmm = lmm_summary$coefficients[[2]],
                                  R2_lmm = summary(lmm_summary)$r.squared,
                                  MSE_lmm = db_validation[, mean(sqErr_lmm)])
      )
  }
```


```{r plot OOB predictions,echo=FALSE,fig.height = 8, fig.width = 12}
  
  # prepare table to save lm() info from the simulations
  n <- length(spIds) * (length(simulations) + 2)
  reg_dt <- data.table(species_id = rep(spIds, (length(simulations) + 2)), sim = character(n), R2 = numeric(n), Slope = numeric(n))
  
  for(sp in spIds)
  {
    # axis limites
    maxGrowth <- oob_growth[species_id == sp, quantile(growth, probs = .975)]
    
    par(mfcol = c(2, length(simulations)), xaxs = "i", las = 1, mar = c(4, 4, 1, 1), oma = c(7, 5, 7, .5), mgp = c(1, 2.5, 0), tck = -.008, cex.lab = 4, cex.axis = 4, cex = 0.3)
  
    # regression (pred ~ real growth)
    reg_sim1 <- lm(Gdet_mean_sim1 ~ growth, data = oob_growth[species_id == sp])
    reg_sim2 <- lm(Gdet_mean_sim2 ~ growth, data = oob_growth[species_id == sp])
    rf_coeffSp <- rf_coeff[species_id == sp, ]

    # add to reg table
    reg_dt[species_id %in% sp, `:=`(sim = c(simulations, 'randomForest', 'LMM'),
                                  R2 = c(summary(reg_sim1)$r.squared, summary(reg_sim2)$r.squared, rf_coeffSp$R2_rf, rf_coeffSp$R2_lmm),
                                  Slope = c(reg_sim1$coefficients[[2]], reg_sim2$coefficients[[2]], rf_coeffSp$Slope_rf, rf_coeffSp$Slope_lmm))]

    # legend
    leg <- c('1:1 line',
              latex2exp::TeX(paste0('LMM: R^2 = ', round(reg_dt[species_id == sp & sim == 'LMM', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'LMM', Slope], 2))),
              latex2exp::TeX(paste0('randomForest: R^2 = ', round(reg_dt[species_id == sp & sim == 'randomForest', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'randomForest', Slope], 2))),
              latex2exp::TeX(paste0('Bayesian sim1: R^2 = ', round(reg_dt[species_id == sp & sim == 'sim1', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'sim1', Slope], 2))),
              latex2exp::TeX(paste0('Bayesian sim2: R^2 = ', round(reg_dt[species_id == sp & sim == 'sim2', R2], 2), '; slope = ', round(reg_dt[species_id == sp & sim == 'sim2', Slope], 2))))
    
    # sample 10% of data
    db <- oob_growth[species_id == sp]
    db <- db[sample(1:nrow(db), floor(nrow(db) * 0.1))]

    for(sim in simulations)
    {
      # plot deterministic growth
      plot(db[, c('growth', paste0('Gdet_mean_', sim)), with = FALSE], xlim = c(0, maxGrowth), ylim = c(0, maxGrowth), pch = 20, col = rgb(0, 0, 0, 0.3), xlab = '', ylab = '', xaxt = 'n', yaxt = ifelse(sim == 'sim1', "s", "n"))
      axis(1, labels = NA)
      if(sim == 'sim2') axis(2, labels = NA)
      abline(0, 1)
      segments(db$growth - 0.01, db[[paste0('Gdet_ci10_', sim)]], db$growth + 0.01, db[[paste0('Gdet_ci10_', sim)]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth - 0.01, db[[paste0('Gdet_ci90_', sim)]], db$growth + 0.01, db[[paste0('Gdet_ci90_', sim)]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth , db[[paste0('Gdet_ci10_', sim)]], db$growth, db[[paste0('Gdet_ci90_', sim)]], col = rgb(0, 0, 0, 0.2)) # vertica
      abline(get(paste0('reg_', sim)), lty = 2)
      abline(rf_coeffSp[species_id == sp]$Int_rf, rf_coeffSp[species_id == sp]$Slope_rf, lty = 3)
      abline(rf_coeffSp[species_id == sp]$Int_lmm, rf_coeffSp[species_id == sp]$Slope_lmm, lty = 4)
      if(sim == 'sim1') legend('topleft', legend = leg, lty = c(1, 4, 3, 2, 2), cex = 2.8, bty = 'n')
      mtext(ifelse(sim == 'sim1', paste('sim1:', sim1name), paste('sim2:', sim2name)), 3, at = 3, cex = 1, line = 0.25)


      # plot gorwth with individual variation
      plot(db[, c('growth', paste0('Gvar_mean_', sim)), with = FALSE], xlim = c(0, maxGrowth), ylim = c(0, maxGrowth), col = rgb(0, 0, 0, 0.3), xlab = '', ylab = '', pch = 20, yaxt = ifelse(sim == 'sim1', "s", "n"))
      axis(2, labels = NA)
      abline(0, 1)
      segments(db$growth - 0.01, db[[paste0('Gvar_ci10_', sim)]], db$growth + 0.01, db[[paste0('Gvar_ci10_', sim)]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth - 0.01, db[[paste0('Gvar_ci90_', sim)]], db$growth + 0.01, db[[paste0('Gvar_ci90_', sim)]], col = rgb(0, 0, 0, 0.2))
      segments(db$growth , db[[paste0('Gvar_ci10_', sim)]], db$growth, db[[paste0('Gvar_ci90_', sim)]], col = rgb(0, 0, 0, 0.2)) # vertica
      abline(get(paste0('reg_', sim)), lty = 2)
      abline(rf_coeffSp[species_id == sp]$Int_rf, rf_coeffSp[species_id == sp]$Slope_rf, lty = 3)
      abline(rf_coeffSp[species_id == sp]$Int_lmm, rf_coeffSp[species_id == sp]$Slope_lmm, lty = 4)

      # text
      mtext(sp, 3, outer = TRUE, cex = 1, line = 2.5)
      mtext('Deterministic growth (mean)', 3, outer = TRUE, cex = 1, line = -0.5)
      mtext('Ind variable growth', 3, outer = TRUE, cex = 1, line = -60)
      mtext('Observed growth rate (mm/y)', 1, outer = TRUE, line = 1.3, cex = 1)
      mtext('Predicted growth rate (mm/y)', 2, las = 0, outer = TRUE, line = 2.2, cex = 1)
    }
  }
```

```{r oob predictions r2, echo = FALSE,fig.height = 6, fig.width = 7, warning=FALSE, message=FALSE}
reg_dt %>%
  mutate(species_id = forcats::fct_reorder(species_id, R2)) %>% 
  ggplot(mapping = aes(x = species_id, y = R2, fill = sim, color = sim)) +
  geom_point() +
  coord_flip()
```

# Mean squared error (MSE) of out-of-bag predictions

Density distribution draws from the posterior distribution ($n = 200$) can be compared with the MSE values using the random forest methods (vertical bars).
Furthermore, I added the `sim_full` MSE when running the random forest with all non-correlated variables to get the maximum explicability from data.

```{r calculate MSE, echo = FALSE}

  #################################
  # Get X random values from posterior distribution to get a distribution of MSE (mean squared error)
  #################################

  # growth model
  growth_model3 <- function(param, sim, D, TP, PP, C, plot_id, indVar = FALSE)
  {
    lgPart <- (log(D/param["Phi_opt"])/param["sigmaPhi_opt"])^2

    # competition
    if(sim == 'sim1')
    {
      compEffect <- (param['Lo'] + ((1 - param['Lo']) / (1 + exp(-param['beta'] * (C - param['mid'])))))
    }else{
     compEffect <- exp(-((C^2)/2*param["sigma_C"]^2))
    }


    if(indVar) {
      pdg_pop <- param["pdg"] + rnorm(length(D), param[paste0('pdg_pmean[', plot_id, ']')], param["pdg_psd"])
      pdg_pop[pdg_pop <= 0] = 0.0001
    }else{
      pdg_pop <- param["pdg"] + param[paste0('pdg_pmean[', plot_id, ']')]
    } 
        
    mu_d <- pdg_pop *
            compEffect *
            exp(-0.5*(TP - param["T_opt"])^2/param["sigmaT_opt"]^2) *
            exp(-0.5*(PP - param["P_opt"])^2/param["sigmaP_opt"]^2) *
            exp(-lgPart)

    if(!indVar)
    {
      growth <- mu_d
    }else {
      growth <- rgamma(length(mu_d), mu_d^2/param["sigma_base"], mu_d/param["sigma_base"])
    }

    return( growth )
  }

  MSE_dt <- data.table()
  sampleN <- 200

  for(sp in spIds)
  {    
    db <- oob_growth[species_id == sp, .(growth, dbh0, bio_01, bio_12, canopyDistance,BA, plot_id_seq)]

    for(sim in simulations)
    {
      # get params
      fit <- get(paste('fit', sim, sp, sep = '_'))
      posterior <- rstan::extract(fit)
      
    # sample X random values from posterior dist
      # First sample for the random effect parameters and rename them
      pdg_pars <- lapply(lapply(seq_len(ncol(posterior[['pdg_pmean']])), function(i) posterior[['pdg_pmean']][,i]), sample, sampleN)
      names(pdg_pars) <- paste0('pdg_pmean[', 1:length(pdg_pars), ']')

      # sample the remaining parameters and merge with pdg_ random effect
      params <- lapply(posterior[-which(names(posterior) == 'pdg_pmean')], sample, sampleN)
      params <- append(params, pdg_pars)

      MSE_det <- MSE_var <- r2 <- numeric(sampleN)
      for(i in 1:sampleN)
      {
        # get pars for one sample
        parsI <- unlist(lapply(params, `[[`, i))

        if(sim == 'sim1')
        {
          # get deterministic growth rate
          db[, g_det_pred := growth_model3(param = parsI, sim, D = dbh0, TP = bio_01, PP = bio_12, C = canopyDistance, plot_id = plot_id_seq, indVar = FALSE)]
          # get growth rate with individual variation
          db[, g_var_pred := growth_model3(param = parsI, sim, D = dbh0, TP = bio_01, PP = bio_12, C = canopyDistance, plot_id = plot_id_seq, indVar = TRUE)]
        }else{
            # get deterministic growth rate
          db[, g_det_pred := growth_model3(param = parsI, sim, D = dbh0, TP = bio_01, PP = bio_12, C = BA, plot_id = plot_id_seq, indVar = FALSE)]
          # get growth rate with individual variation
          db[, g_var_pred := growth_model3(param = parsI, sim, D = dbh0, TP = bio_01, PP = bio_12, C = BA, plot_id = plot_id_seq, indVar = TRUE)]
        }

        # calculate MSE
        MSE_det[i] <- mean(db[, (growth - g_det_pred)^2])
        MSE_var[i] <- mean(db[, (growth - g_var_pred)^2])

        # Calculate R2 (Gelman et al 2018)
        # Doing for det_growth only as it considers the sigma_base parameter in the R2 equation
        
        # Variance of modelled predictive means
        varPred <- db[, var(g_det_pred)]
        # Variance of modelled residual
        var_res <- parsI['sigma_base']
        # Rsquared = varPred/(varPred + var_res)      
        r2[i] <- varPred/(varPred + var_res)

      }

      # update main dt
      MSE_dt <- rbind(
        MSE_dt, 
        data.table(
          species_id = sp,
          sim = sim,
          MSE_det = MSE_det,
          MSE_var = MSE_var,
          r2 = r2
        )
      )
    }
  }

```

```{r plot MSE,echo=FALSE,fig.height = 6, fig.width = 8, warning=FALSE, message=FALSE}
  
  # Rename rf_coeff for legend
  rf_coeff_lg <- rf_coeff %>%
                  pivot_longer(!species_id, names_to = 'Method', values_to = 'value') %>%
                  mutate(
                    Method = plyr::revalue(
                      Method,
                      c('MSE_rf' = 'Random forest', 'MSE_lmm' = 'LMM')
                    )
                  )

  # For deterministic growth
  ggplot(data = MSE_dt, aes(MSE_det, species_id, fill = sim, colour = sim)) + 
    geom_density_ridges(alpha = 0.4, scale= 1.8) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'Random forest'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'LMM'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    xlim(0, 7.6) +
    theme_classic() +
    ggtitle('Deterministic growth') +
    xlab('MSE') +
    scale_y_discrete(limits = rev(spIds))


  # For ind variation growth
    ggplot(data = MSE_dt, aes(MSE_var, species_id, fill = sim, colour = sim)) + 
      geom_density_ridges(alpha = 0.4, scale= 1.8) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'Random forest'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    geom_segment(data = subset(rf_coeff_lg, Method == 'LMM'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    xlim(0, 7.6) +
    theme_classic() +
    ggtitle('Ind variable growth') +
    xlab('MSE') +
    scale_y_discrete(limits = rev(spIds))

```


# Rsquared

Rsquared values draw from the posterior distribution is calculated using the Gelman et al. [2018](http://www.stat.columbia.edu/~gelman/research/unpublished/bayes_R2.pdf) definition.
Like MSE, the $R^{2}$ can be compared with the ones from the random forest using the same variables along with the full model (`sim_full`). However, the $R^{2}$ of the random forest is calculated using the classical equation.

```{r plot Rsquared,echo=FALSE,fig.height = 6, fig.width = 8, warning=FALSE, message=FALSE}
  
  # load random forest MSE information
  rf_coeff_r2 <- rf_coeff_lg %>%
                 dplyr::filter(Method %in% c('R2_rf', 'R2_lmm')) %>%
                 mutate(Method = plyr::revalue(Method, c('R2_rf' = 'Random forest', 'R2_lmm' = 'LMM')))

  xMax <- max(c(rf_coeff_r2$value, MSE_dt$r2))

  # For deterministic growth
  ggplot(data = MSE_dt, aes(r2, species_id, fill = sim, colour = sim)) + 
    geom_density_ridges(alpha = 0.4, scale= 1.8) +
    geom_segment(data = subset(rf_coeff_r2, Method == 'Random forest'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    geom_segment(data = subset(rf_coeff_r2, Method == 'LMM'), aes(linetype = `Method`, x = value, xend = value, y = length(species_id):1,
                                      yend = (length(species_id):1) + .8),
               color = "black", alpha = 0.6) +
    xlim(0, xMax) +
    theme_classic() +
    xlab('Rsquared') +
    scale_y_discrete(limits = rev(spIds))

```


# Intraclass Correlation Coefficient (ICC)

```{r calculate ICC, echo = FALSE}
icc <- data.table()
for(sp in spIds) {
  for(sim in simulations) {
    out <- rstan::extract(get(paste('fit', sim, sp, sep = '_')))
    
    alpha1 <- out[['pdg_psd']]^2
    alpha2 <- out[['sigma_base']]
    ic <- alpha1/(alpha1 + alpha2)

    icc <- rbind(
      icc,
      data.table(
        species_id = sp,
        sim = sim,
        icc = ic
      )
    )
  }
}
```

```{r plot icc,echo=FALSE,fig.height = 6, fig.width = 8, warning=FALSE, message=FALSE}
# For deterministic growth
ggplot(data = icc, aes(icc, species_id, fill = sim, colour = sim)) + 
  geom_density_ridges(alpha = 0.4, scale= 1.8) +
  theme_classic() +
  xlab('ICC') +
  scale_y_discrete(limits = rev(spIds))

# create uniqueID by group to make merge possible
MSE_dt[, ID := 1:.N, by = .(species_id, sim)]

# From the rstan extract object, sample N iterations to plot R2 vs ICC dist
icc %>%
  group_by(species_id, sim) %>%
  summarise(icc = sample(icc, sampleN)) %>%
  group_by(species_id, sim) %>%
  mutate(ID = 1:n()) %>%
  left_join(MSE_dt, by = c('species_id', 'sim', 'ID')) %>%
  group_by(species_id, sim) %>%
  summarise(
    icc_mean = mean(icc),
    icc_min = icc_mean - sd(icc),
    icc_max = icc_mean + sd(icc),
    r2_mean = mean(r2),
    r2_min = r2_mean - sd(r2),
    r2_max = r2_mean + sd(r2)
  ) %>%
  ggplot(aes(r2_mean, icc_mean, color = species_id, shape = sim)) +
    geom_point() +
    geom_errorbar(aes(ymin = icc_min, ymax = icc_max), alpha = .5) + 
    geom_errorbarh(aes(xmin = r2_min,xmax = r2_max), alpha = .5) +
    theme_classic() +
    ylab('Mean ICC')
```

# Population summary

```{r popSummary, echo = FALSE,fig.height = 12, fig.width = 7, warning=FALSE, message=FALSE}
p1 <- oob_growth %>%
  select(species_id, 'growth', contains('Gvar')) %>%
  pivot_longer(
    cols = starts_with('G'),
    names_to = 'pars',
    values_to = 'value'
  )  %>%

  mutate(
    pars = recode(
      pars,
      growth = 'Observed',
      Gvar_mean_sim1 = 'Predicted_sim1',
      Gvar_ci10_sim1 = 'Predicted_sim1',
      Gvar_ci90_sim1 = 'Predicted_sim1',
      Gvar_mean_sim2 = 'Predicted_sim2',
      Gvar_ci10_sim2 = 'Predicted_sim2',
      Gvar_ci90_sim2 = 'Predicted_sim2'
    )
  ) %>%
  ggplot(aes(x = value, y = species_id, fill = pars)) +
    geom_density_ridges(alpha = 0.3) +
    xlim(0, 12) +
    xlab('Growth')

print(p1)
```


# Sampling time

```{r sampling time, echo = FALSE}
samplingDF <- data.frame()

for(sim in simulations) {
  for(sp in spIds) {
    simNames <- paste('fit', sim, sp, sep = '_')
    sumTime <- rowSums(get_elapsed_time(get(simNames)))
    nChain <- length(sumTime)
    df1 <- data.frame(sim = rep(sim, nChain),
                     sp = rep(sp, nChain),
                     time = sumTime)
    samplingDF <- rbind(samplingDF, df1)
  }
}

samplingDF$time <- samplingDF$time/60/60
```

```{r plot sampling time, echo = FALSE, fig.height = 6, fig.width = 12}

p <- ggplot(data = samplingDF, aes(x = sim, y = time)) +
      geom_boxplot() +
      facet_grid(~sp) +
      theme_classic() +
      ylab('Time (h)')
print(p)
```
```{r plot sampling time2, echo = FALSE, fig.height = 5, fig.width = 6}
p <- ggplot(data = samplingDF, aes(x = sim, y = time)) +
      geom_boxplot() +
      theme_classic() +
      ylab('Time (h)')
print(p)
```

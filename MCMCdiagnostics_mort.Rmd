---
 title: "MCMC diagnostics - Mortality"
 subtitle: "Test v9.0 - random effect plot:year"
 author: "Will Vieira"
 date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---


## Test if plot:year random effects on baseline longevity improve predictions:

- **sim1**: year random effect on $\psi$
- **sim2**: plot:year random effect on $\psi$

```{r, echo=F,warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(require(RColorBrewer))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggpubr))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(data.table))
```
```{r load simulations, echo = F}
# Load simulation variables
  simInfo <- yaml::read_yaml('_simulation_info.yml')

  # species id
  if(is.null(simInfo$spIds)) {
    spIds <- readRDS('data/spIds.RDS')
  }else {
    spIds <- simInfo$spIds
  }

  simName <- simInfo$simName

  simulations <- simInfo$simulations

  # Human readble simName
  sim1name <- 'year random effect'
  sim2name <- 'plot:year random effect'

#


# Load rStan output and scaleInfo for all species_id
  # get output name for each species_id
  simNames = list.files(path = paste('output', simName, sep = '/'), pattern = '.RDS', recursive = TRUE, full.names = TRUE)
  output = simNames[grep('mortMCMC', simNames)]

  # get name of parameters for each simulation
  for(sim in simulations)
  {
    # get one MCMC file for a specific sim
    sim_out <- readRDS(grep(sim, output, value = TRUE)[1])
    assign(paste0('pars_', sim), rownames(summary(sim_out)[[1]]))
  }

#

###########################################
# Diagnostics
###########################################
```


```{r load all metrics, echo = FALSE}

# data.frames to fill for each simulation and species ID
Rhat <- data.frame()
divergentDF <- data.frame()
mcmcSampleDF <- data.frame()
samplingDF <- data.frame()

for(sim in simulations)
{
  for(sp in spIds)
  {
    # load simulation
    sim_sp_output <- readRDS(grep(sim, grep(sp, output, value = TRUE), value = TRUE))


    # Rhat section
    df <- summary(sim_sp_output)$summary
    nRow = nrow(df)
    dfToAdd <- data.frame(
        sim = sim,
        sp = sp,
        pars = rownames(df),
        Rhat = df[, 'Rhat'],
        row.names = NULL
    )
    Rhat <- rbind(Rhat, dfToAdd)


    # Divergent transitions section
    sampler_params <- get_sampler_params(sim_sp_output, inc_warmup = FALSE)
    nbDivergent <- sum(
      unlist(
        lapply(
          sampler_params,
          function(mat)
            mat[, 'divergent__']
        )
      )
    )

    divergentDF <- rbind(
      divergentDF,
      data.frame(
        sim = sim,
        sp = sp,
        nbDivergent = nbDivergent
      )
    )


    # Sampling section
    dfToAdd <- gather(as.data.frame(sim_sp_output), key = 'pars')
    dfToAdd <- subset(dfToAdd, pars %in% grep('psi_pmean', get(paste0('pars_', sim)), value = TRUE, invert = TRUE))
    dfToAdd$sim <- sim
    dfToAdd$sp <- sp

    mcmcSampleDF <- rbind(
      mcmcSampleDF,
      dfToAdd
    )


    # sampling time
    sumTime <- rowSums(get_elapsed_time(sim_sp_output))

    samplingDF <- rbind(
      samplingDF,
      data.frame(
        sim = sim,
        sp = sp,
        time = sumTime/60/60
      )
    )
  }
}

# Get the parameters from the random plot_id
# mcmcsSampleDF_random <- subset(mcmcSampleDF, pars %in% grep('psi_pmean', unique(mcmcSampleDF$pars), value = TRUE))
```

# Rhat

```{r, echo = F, fig.height = 6, fig.width = 10}
  p <- ggplot(data = Rhat, aes(x = sp, y = Rhat)) +
       geom_boxplot() +
       coord_flip() +
       facet_grid(~sim) +
       theme_classic()
  print(p)
```



# Divergent transitions

```{r divergent table, echo = FALSE}
DT::datatable(divergentDF)
```



# Density plot of each parameter by species id

```{r plot mcmcSample by pars, echo = F, message=FALSE, fig.height = 7, fig.width = 9}
  parsToPlot <- setdiff(unique(mcmcSampleDF$pars), grep('psi_pmean', unique(mcmcSampleDF$pars), value = TRUE))
  for(par in parsToPlot)
  {
    p <- ggplot(data = subset(mcmcSampleDF, pars == par), aes(value, sp, fill = sim, color = sim)) +
         geom_density_ridges(alpha = 0.5) +
         theme_classic() +
         xlab(par)
    print(p)
  }

  # ggplot(data = mcmcSampleDF_random, aes(value, sp)) +
  #       geom_density_ridges(alpha = 0.5) +
  #       theme_classic() +
  #       xlab('Random effect of psi at the population level')
```

# Data distribution

```{r organize data, echo = FALSE}
mort_dt <- readRDS('data/quebec/mort_dt.RDS')
mort_dt <- mort_dt[sp_code2 %in% spIds]
mort <- mort_dt[, .(sp_code2, mort, dbh0, value5_bio60_01, value5_bio60_12, BA)]

# transform dt
mort <- tidyr::gather(data = mort,
            mort, dbh0, value5_bio60_01, value5_bio60_12, BA,
            key = 'var', value = 'value')
```

```{r plot data distribution, echo = FALSE, message=FALSE, fig.height = 7, fig.width = 10}
p <- ggplot(data = mort, aes(value, sp_code2)) +
      geom_density_ridges_gradient() +
      facet_grid(~var, scales = 'free_x') + #,
      #          labeller = labeller(sim = setNames(c(sim1name,
      #                              sim2name),
      #                              c('sim1', 'sim2')))) +
      theme_classic()
print(p)
```


# Size, temperature, precipitation and competition effect

## Survival functions

```{r function effects, echo = F, fig.height = 11, fig.width = 9}
# Plot of size, temperature, precipitation and competition effect

  # define functions of the model
    # size effect
    sizeEffect = function(x, DBHopt, DBHvar) {
      lgPart <- (log(x/DBHopt)/DBHvar)^2
      return( exp(-lgPart))
    }

    # temperature effect
    tempEffect = function(xtemp, T_opt, sigmaT_opt) {
      return(exp(-0.5*(xtemp - T_opt)^2/sigmaT_opt^2))
    }

    # precipitation effect
    precEffect = function(xprec, P_opt, sigmaP_opt) {
      return(exp(-0.5*(xprec - P_opt)^2/sigmaP_opt^2))
    }

    # competition effect
    compEffect = function(xba, param, sim) {
        return(param[param$pars == 'Lo', 4] + ((1 - param[param$pars == 'Lo', 4]) / (1 + exp(0.25 * (xba - param[param$pars == 'Mid', 4])))))
    }

  #

  ## PLOT ##

  # define x axis
  sizex = seq(91, 700, 0.5)
  tempx = seq(-8, 25)
  precx = seq(500, 1700)
  BAx = seq(0, 80, 0.1)

  # species specfic colours
  spCols <- setNames(rev(RColorBrewer::brewer.pal(length(spIds), "Set3")), spIds)

  # get sample mean
  mcmc_mean <- mcmcSampleDF %>%
    group_by(sp, sim, pars) %>%
    summarise(mean_par = mean(value)) %>%
    as.data.frame()

  par(mfrow = c(4, length(simulations)), xaxs = "i", las = 1, mar = c(3, 1, 1.5, 1.5), oma = c(1,3.5,2,.2), mgp = c(1.5, 0.3, 0), tck = -.008, cex.lab = 1.2, cex.axis = 1.2)

  # plot size effect
  for(Sim in simulations) {
    for(Sp in spIds) {
      # get parameters
      out <- subset(mcmc_mean, sp == Sp & sim == Sim)

      # plot
      if(Sp == spIds[1]) plot(sizex, sizeEffect(sizex, out[out$pars == 'DBHopt', 4], out[out$pars == 'DBHvar', 4]),
                  type = 'l', ylim = c(0, 1), xlab = 'Size (mm)', ylab = 'Size effect',
                  col = spCols[Sp],
                  yaxt = ifelse(Sim == 'sim1', "s", "n"))
      if(Sim == 'sim2') axis(2, labels = FALSE)
      points(sizex, sizeEffect(sizex, out[out$pars == 'DBHopt', 4], out[out$pars == 'DBHvar', 4]), type = 'l', col = spCols[Sp])
    }
    mtext(ifelse(Sim == 'sim1', sim1name, ifelse(Sim == 'sim2', sim2name, sim3name)), side = 3, line = 0)
    if(Sim == 'sim1') mtext("Size effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot temp effect
  for(Sim in simulations) {
    for(Sp in spIds) {
      # get parameters
      out <- subset(mcmc_mean, sp == Sp & sim == Sim)

      topt <- out[out$pars == 'T_opt', 4]
      sigTopt <- out[out$pars == 'sigmaT_opt', 4]

      if(Sp == spIds[1]) plot(tempx, tempEffect(tempx, topt, sigTopt), type = 'l',
                  ylim = c(0, 1), xlab = 'Temperature (°C)', ylab = 'Temperature effect',
                  col = spCols[Sp],
                  yaxt = ifelse(Sim == 'sim1', "s", "n"))
      if(Sim == 'sim2') axis(2, labels = FALSE)
      points(tempx, tempEffect(tempx, topt, sigTopt), type = 'l', col = spCols[Sp])
    }
    if(Sim == 'sim1') mtext("Temperature effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot precipitation effect
  for(Sim in simulations) {
    for(Sp in spIds) {
      # get parameters
      out <- subset(mcmc_mean, sp == Sp & sim == Sim)

      popt <- out[out$pars == 'P_opt', 4]
      sigPopt <- out[out$pars == 'sigmaP_opt', 4]

      if(Sp == spIds[1]) plot(precx, precEffect(precx, popt, sigPopt), type = 'l',
                  ylim = c(0, 1), xlab = 'Precipiation (mm)', ylab = 'Precipiation effect',
                  col = spCols[Sp],
                  yaxt = ifelse(Sim == 'sim1', "s", "n"))
      if(Sim == 'sim2') axis(2, labels = FALSE)
      points(precx, precEffect(precx, popt, sigPopt), type = 'l', col = spCols[Sp])
    }
    if(Sim == 'sim1') mtext("Precipiation effect", 2, las = 0, cex = .8, line = 1.9)
  }

  # plot basal area effect
  for(Sim in simulations) {
    for(Sp in spIds) {
      # get parameters
      out <- subset(mcmc_mean, sp == Sp & sim == Sim)

      if(Sp == spIds[1]) plot(BAx, compEffect(BAx, param = out, sim = sim),
      ylim = c(0, 1), type = 'l', xlab = 'Basal area (m2/ha)', ylab = 'Competition effect',
      col = spCols[Sp],
      yaxt = ifelse(Sim == 'sim1', "s", "n"))
      if(Sim == 'sim2') axis(2, labels = FALSE)

      points(BAx, compEffect(BAx, param = out, sim = Sim), type = 'l', col = spCols[Sp])
    }

    if(Sim == 'sim1') mtext("Competition effect", 2, las = 0, cex = .8, line = 1.9)
  }
  legend('topleft', legend = spIds, col = spCols, lty = 1, lwd = 1.5, bty = 'n', cex = 0.7)
```



# Predictions

```{r prediction functions, echo = F,fig.width = 9,message = FALSE}
# Plot predictions
  # define model

  mort_model <- function(param, sim, newdata) {

    lgPart <- (log(newdata$D/param["DBHopt"])/param["DBHvar"])^2

    mort <- 1 / (1 + (param["psi"] *
                ((param["Lo"] + ((1 - param["Lo"]) / (1 + exp(0.25 * (newdata$CD - param["Mid"])))))) *
                exp(-0.5*(newdata$TP - param["T_opt"])^2/param["sigmaT_opt"]^2) *
                exp(-0.5*(newdata$PP - param["P_opt"])^2/param["sigmaP_opt"]^2) *
                exp(-lgPart)))
    mort_df <- cbind(mort, newdata)
  }

  # Function in which you give a rstan output (species_id) and it returns the three plots
  plot_prediction <- function(Sim, Sp, model, data) {

    # Prepare data
    newdataT <- data[['newdataT']]
    newdataP <- data[['newdataP']]
    newdataD <- data[['newdataD']]
    newdataC <- data[['newdataC']]

    # Prepare parameters
    fit <- subset(mcmcSampleDF, sim == Sim & sp == Sp) %>%
      group_by(pars) %>%
      summarise(
        mean = mean(value),
        ci10 = quantile(value, 0.025),
        ci90 = quantile(value, 0.975)
      )
    
    # define parameters
    param_mean <- setNames(fit$mean, fit$pars)
    param_ci10 <- setNames(fit$ci10, fit$pars)
    param_ci90 <- setNames(fit$ci90, fit$pars)

    # get predictions
    mort_meanT <- mort_model(param = param_mean, sim = Sim, newdata = newdataT)
    mort_ci10T <- mort_model(param = param_ci10, sim = Sim, newdata = newdataT)
    mort_ci90T <- mort_model(param = param_ci90, sim = Sim, newdata = newdataT)

    mort_meanP <- mort_model(param = param_mean, sim = Sim, newdata = newdataP)
    mort_ci10P <- mort_model(param = param_ci10, sim = Sim, newdata = newdataP)
    mort_ci90P <- mort_model(param = param_ci90, sim = Sim, newdata = newdataP)

    mort_meanD <- mort_model(param = param_mean, sim = Sim, newdata = newdataD)
    mort_ci10D <- mort_model(param = param_ci10, sim = Sim, newdata = newdataD)
    mort_ci90D <- mort_model(param = param_ci90, sim = Sim, newdata = newdataD)

    mort_meanC <- mort_model(param = param_mean, sim = Sim, newdata = newdataC)
    mort_ci10C <- mort_model(param = param_ci10, sim = Sim, newdata = newdataC)
    mort_ci90C <- mort_model(param = param_ci90, sim = Sim, newdata = newdataC)


    cd2plot <- unique(newdataT$CD)
    colcd <- rev(RColorBrewer::brewer.pal(length(cd2plot) + 1, "PuBuGn"))

    if(sim == 'sim1')
      par(mfcol = c(4, length(simulations)), xaxs="i", las = 1, mar = c(3, 1, 3, 1.5), oma = c(1,3.5,2,.2), mgp = c(1.5, 0.3, 0), tck = -.008, cex.lab = 1.2, cex.axis = 1.2)

    # Mortality vs temperature
    plot(mort ~ TP, mort_ci10T, type = "n", ylim = c(0, 1),
         xlab = "Temperature (°C)", ylab = "", cex.lab = 1.2, yaxt = ifelse(sim == 'sim1', "s", "n"))
    if(Sim == 'sim2') axis(2,labels=F)

    for(cd in cd2plot) {
      mu <- subset(mort_meanT, CD == cd)
      ci10 <- subset(mort_ci10T, CD == cd)
      ci90 <- subset(mort_ci90T, CD == cd)
      mycol <- colcd[cd2plot == cd]

      lines(mort ~ TP, mu, cex=.5, pch=19, col = mycol)
      polygon(c(mu$TP, rev(mu$TP)),
              c(ci10$mort, rev(ci90$mort)),
              col = alpha(mycol, 0.5), border = NA)
    }
    legend("topleft", legend = cd2plot, title = ifelse(Sim == 'sim1', "Canopy distance", "Basal area"),
            fill = colcd[1:3], bty = "n", border = "transparent")

    # data range
    abline(v = mort_dt[sp_code2 == sp, range(value5_bio60_01)], col = 'grey', lty = 2)

     mtext(ifelse(Sim == 'sim1', sim1name, ifelse(Sim == 'sim2', sim2name, sim3name)), side = 3, line = 0)
     mtext(Sp, side = 3, outer = TRUE, cex = 1, line = -1.8)

    # Mortality vs precipitation
    plot(mort ~ PP, mort_ci10P, type = "n", ylim = c(0, 1),
         xlab = "Precipiation (mm)", ylab = " ", yaxt = ifelse(sim == 'Sim1', "s", "n"), cex.lab = 1.2)
    axis(2, labels = F)
    for(cd in cd2plot) {
      mu <- subset(mort_meanP, CD == cd)
      ci10 <- subset(mort_ci10P, CD == cd)
      ci90 <- subset(mort_ci90P, CD == cd)
      mycol <- colcd[cd2plot == cd]

      lines(mort ~ PP, mu, cex = .5, pch = 19, col = mycol)
      polygon(c(mu$PP, rev(mu$PP)),
              c(ci10$mort, rev(ci90$mort)),
              col = alpha(mycol, 0.5), border = NA)
    }
    mtext("P(Mortality)/year", 2, outer = T, las = 0, cex = .8, line = 1.5)

    # data range
    abline(v = mort_dt[sp_code2 == Sp, range(value5_bio60_12)], col = 'grey', lty = 2)
    
    # Mortality vs size
    plot(mort ~ D, mort_ci10D, type = "n", ylim = c(0, 1),
         xlab = "Size (mm)", ylab = "", yaxt = ifelse(Sim == 'sim1', "s", "n"), cex.lab = 1.2)
    axis(2, labels = F)
    for(cd in cd2plot) {
      mu <- subset(mort_meanD, CD == cd)
      ci10 <- subset(mort_ci10D, CD == cd)
      ci90 <- subset(mort_ci90D, CD == cd)
      mycol <- colcd[cd2plot == cd]

      lines(mort ~ D, mu, cex = .5, pch = 19, col = mycol)
      polygon(c(mu$D, rev(mu$D)),
              c(ci10$mort, rev(ci90$mort)),
              col = alpha(mycol, 0.5), border = NA)
    }

    # data range
    abline(v = mort_dt[sp_code2 == Sp, range(dbh0)], col = 'grey', lty = 2)

    # Mortality vs competition
    plot(mort ~ CD, mort_ci10C, type = "n", ylim = c(0, 1),
         xlab = ifelse(Sim == 'sim1', "Canopy distance from S* (m)", "Basal area (m²/ha)"), ylab = "", yaxt = ifelse(sim == 'sim1', "s", "n"), cex.lab = 1.2)
    axis(2, labels = F)
    lines(mort ~ CD, mort_meanC, cex = .5, pch = 19, col = mycol)
      polygon(c(mort_meanC$CD, rev(mort_meanC$CD)),
              c(mort_ci10C$mort, rev(mort_ci90C$mort)),
              col = alpha(mycol, 0.5), border = NA)

    # add data range
    if(Sim == 'sim1')
    {
      abline(v = mort_dt[sp_code2 == Sp, range(canopyDistance)], col = 'grey', lty = 2)
    }else{
      abline(v = mort_dt[sp_code2 == Sp, range(BA)], col = 'grey', lty = 2)
    }  
  }
  ```

  ```{r plot predictions,echo=FALSE,fig.height = 12, fig.width = 8}
  # plot all species
  for(sp in spIds) {
    for(sim in simulations) {
      # Temp
      newdataT <- data.frame(expand.grid(CD = c(5, 20, 40),
                                        TP = seq(-10, 25, length.out = 300),
                                        PP = 1000,
                                        D = 200))
      # Prec
      newdataP <- data.frame(expand.grid(CD = c(5, 20, 40),
                                        TP = 4,
                                        PP = seq(250, 1800, length.out = 300),
                                        D = 200))
      # Size
      newdataD <- data.frame(expand.grid(CD = c(5, 20, 40),
                                        TP = 4,
                                        PP = 1000,
                                        D = seq(0, 1200, length.out = 300)))
      # Canopy distance
      newdataC <- data.frame(expand.grid(CD = seq(0, 80, length.out = 300),
                                        TP = 4,
                                        PP = 1000,
                                        D = 200))

      plot_prediction(sim, sp, mort_model,
        data = list(newdataT = newdataT, newdataP = newdataP, newdataD = newdataD, newdataC = newdataC))
    }
  }
  #
#
```


# Out-of-bag accuracy

Using four different metrics:

- **Sensitivity** measures the percentage of dead trees that are identified as dead
- **Specificity** measures the percentage of alive trees that are correctly identified as alive
- **Accuracy** is the ratio of number of correct predictions to the total of predictions
- **Accuracy balanced** considers unbalanced accuracy predictions of positive and negative events (sensitivity and specificity)

```{r organize data by sp for OOB predictions,echo=FALSE,fig.height = 12, fig.width = 12}
  # create a list of data.table objects for each spIds
  # For each data.table, we will get all rows that were not used in the fitting stan model

  oob_list <- list()
  for(sp in spIds)
  {
    # sp specific db
    db <- mort_dt[sp_code2 == sp]

    # load plot_id references and update plot_id to ID_PE
    toSub_sim1 <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/toSub_sim1.RDS'))
    db[toSub_sim1, on = .(year0), year_sq := i.year_sq]
    toSub_sim2 <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/toSub_sim2.RDS'))
    db[toSub_sim2, on = .(year0, ID_PE), plotYear := i.plotYear]

    # load rows used for stan fit
    sampledIndices <- readRDS(paste0('output/', simName, '/', sp, '/sampleInfo/sampledIndices.RDS'))

    # get validation dataset
    db <- db[!sampledIndices, ]

    oob_list[[sp]] <- db[!(is.na(year_sq) | is.na(plotYear)), ]
  }
```

```{r calculate OOB predictions and confusion matrix, echo=FALSE,fig.height = 12, fig.width = 12}
  mort_model2 <- function(param, sim, year, plotYear, D, TP, PP, C)
  {
    if(sim == 'sim1') {
      psi_pop <- param["psi"] + param[paste0("psi_pmean[", year, "]")]
    }else{
      psi_pop <- param["psi"] + param[paste0("psi_pmean[", plotYear, "]")]
    }


    lgPart <- (log(D/param["DBHopt"])/param["DBHvar"])^2

    mort <- 1 / (1 + (psi_pop *
                ((param["Lo"] + ((1 - param["Lo"]) / (1 + exp(0.25 * (C - param["Mid"])))))) *
                exp(-0.5*(TP - param["T_opt"])^2/param["sigmaT_opt"]^2) *
                exp(-0.5*(PP - param["P_opt"])^2/param["sigmaP_opt"]^2) *
                exp(-lgPart)))
    
    return( mort )

  }

  acc_dt <- data.table(sp = character(),
                       sim = character(),
                       Acc = numeric(),
                       Sensitivity = numeric(),
                       Specificity = numeric(),
                       AccCorrected = numeric())
  sampleN <- 300
  count <- 0; totalN <- sampleN * length(sim) * length(spIds)

  for(sp in spIds)
  {
    db <- oob_list[[sp]]

    for(sim in simulations)
    {
      # get params
      fit <- readRDS(grep(sim, grep(sp, output, value = TRUE), value = TRUE))
      posterior <- rstan::extract(fit)
    
      # First sample for the random effect parameters and rename them
      psi_pars <- lapply(lapply(seq_len(ncol(posterior[['psi_pmean']])), function(i) posterior[['psi_pmean']][, i]), sample, sampleN)
      names(psi_pars) <- paste0('psi_pmean[', 1:length(psi_pars), ']')
      # sample the remaining parameters and merge with pdg_ random effect
      params <- lapply(posterior[-which(names(posterior) == 'psi_pmean')], sample, sampleN)
      params <- append(params, psi_pars)
      
      Acc <- Sensitivity <- Specificity <- AccCorrected <- numeric(sampleN)
      for(i in 1:sampleN)
      {
        pars <- unlist(lapply(params, `[[`, i))
        
        # get mortality
        db[, mortByYear := 1 - mort_model2(param = pars, sim = sim, year = year_sq, plotYear = plotYear, D = dbh0, TP = value5_bio60_01, PP = value5_bio60_12, C = BA)]
        db[, mort_det := 1 - (mortByYear^deltaYear)]
        db[, mort_pred := LaplacesDemon::rbern(dbh0, mort_det)]

        TP <- db[mort == 1 & mort_pred == 1, .N]
        TN <- db[mort == 0 & mort_pred == 0, .N]
        FN <- db[mort == 0 & mort_pred == 1, .N]
        FP <- db[mort == 1 & mort_pred == 0, .N]

        Acc[i] <- (TP + TN)/(TP + TN + FP + FN)
        Sensitivity[i] <- TP/(TP + FN)
        Specificity[i] <- TN/(FP + TN)
        AccCorrected[i] <- (Sensitivity[i] + Specificity[i])/2
      }      
      acc_dt <- rbind(acc_dt, data.table(sp = rep(sp, sampleN), sim = rep(sim, sampleN), Acc = Acc, Sensitivity = Sensitivity, Specificity = Specificity, AccCorrected = AccCorrected))
    }
    oob_list[[sp]] <- db
  }

  rm(oob_list, db, sampledIndices)

```

```{r plot confusion matrix,echo=FALSE,message=FALSE,warning=FALSE,fig.height = 12, fig.width = 8}

  # load random forest output
  rf_dt <- readRDS('data/quebec/randomForest_mort.RDS')
  rf_dt <- rf_dt[rev(spIds), on = "sp"] # reorder to match spIds order
  rf_dt$RandomForest <- plyr::revalue(rf_dt$model, c('1' = 'sim1', '2' = 'sim2', 'Full' = 'sim_full'))

  p1 <- ggplot(acc_dt) +
          geom_density_ridges(aes(Acc, sp, colour = sim, fill = sim), alpha = 0.4) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim1'), aes(linetype = `RandomForest`, x = acc, xend = acc, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "red", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim2'), aes(linetype = `RandomForest`, x = acc, xend = acc, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "#4aaab0", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim_full'), aes(linetype = `RandomForest`, x = acc, xend = acc, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "black", alpha = 0.6) +
          xlab('Accuracy (%)') +
          xlim(0.65, .91) +
          theme(legend.position = 'none') +
          theme_classic() +
          scale_y_discrete(limits = spIds)

  p2 <- ggplot(acc_dt) +
          geom_density_ridges(aes(AccCorrected, sp, colour = sim, fill = sim), alpha = 0.4) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim1'), aes(linetype = `RandomForest`, x = accCorrected, xend = accCorrected, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "red", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim2'), aes(linetype = `RandomForest`, x = accCorrected, xend = accCorrected, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "#4aaab0", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim_full'), aes(linetype = `RandomForest`, x = accCorrected, xend = accCorrected, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "black", alpha = 0.6) +
          xlab('Accuracy corrected (%)') +
          theme_classic() +
          scale_y_discrete(limits = spIds)
  
  p3 <- ggplot(acc_dt) +
          geom_density_ridges(aes(Sensitivity, sp, colour = sim, fill = sim), alpha = 0.4) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim1'), aes(linetype = `RandomForest`, x = sensitivity, xend = sensitivity, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "red", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim2'), aes(linetype = `RandomForest`, x = sensitivity, xend = sensitivity, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "#4aaab0", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim_full'), aes(linetype = `RandomForest`, x = sensitivity, xend = sensitivity, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "black", alpha = 0.6) +
          theme(legend.position = 'none') +
          theme_classic() +
          scale_y_discrete(limits = spIds)

  p4 <- ggplot(acc_dt) +
          geom_density_ridges(aes(Specificity, sp, colour = sim, fill = sim), alpha = 0.4) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim1'), aes(linetype = `RandomForest`, x = specificity, xend = specificity, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "red", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim2'), aes(linetype = `RandomForest`, x = specificity, xend = specificity, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "#4aaab0", alpha = 0.6) +
          geom_segment(data = subset(rf_dt, RandomForest == 'sim_full'), aes(linetype = `RandomForest`, x = specificity, xend = specificity, y = length(sp):1,
                                  yend = (length(sp):1) + .8),
            color = "black", alpha = 0.6) +
          theme_classic() +
          scale_y_discrete(limits = spIds)

  ggpubr::ggarrange(p1, p2, p3, p4, nrow = 2, ncol = 2, common.legend = TRUE, legend = 'bottom')

```

```{r plot sensitivity vs specificity,echo=FALSE,message=FALSE,warning=FALSE,fig.height = 6, fig.width = 8}
  # Summarize data
  acc_summary <- acc_dt %>%
                 dplyr::group_by(sp, sim) %>%
                 dplyr::summarise(mean_sens = mean(Sensitivity),
                           sd_sens = sd(Sensitivity),
                           mean_spec = mean(Specificity),
                           sd_spec = sd(Specificity))

  ggplot(acc_summary, aes(x = mean_sens, y = mean_spec)) +
    geom_pointrange(aes(xmin = mean_sens-sd_sens, xmax = mean_sens+sd_sens), shape = 20, size = 0.3) +
    geom_pointrange(aes(ymin = mean_spec-sd_spec, ymax = mean_spec+sd_spec), shape = 20, size = 0.3) +
    xlab('Sensitivity (%)') +
    ylab('Specificity (%)') +
    geom_text(aes(label = sp), hjust = -.2, vjust = -.5, size = 2) +
    facet_grid(~sim)
```

# Sampling time

```{r plot sampling time, echo = FALSE, fig.height = 6, fig.width = 12}
p <- ggplot(data = samplingDF, aes(x = sim, y = time)) +
      geom_boxplot() +
      facet_grid(~sp) +
      theme_classic() +
      ylab('Time (h)')
print(p)
```
```{r plot sampling time2, echo = FALSE, fig.height = 5, fig.width = 6}
p <- ggplot(data = samplingDF, aes(x = sim, y = time)) +
      geom_boxplot() +
      theme_classic() +
      ylab('Time (h)')
print(p)
```
